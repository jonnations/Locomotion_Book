---
title: "Interactions"
output: html_notebook
---


Playing around with interactions between log_Mass and MANUS
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, brms, cmdstanr, here, tidybayes, patchwork, glue, ggthemes)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))
nms <- read_rds(here("Data", "Order_Names.Rds"))

source(here("Code","Name_Change.R"))


```


### Load Data  

```{r}
dat <- read_csv(here("Data", "Extant_Master.csv"))

fdat <- read_csv(here("Data", "Fossil_Master.csv"))

fdat_cln <- fdat %>% janitor::remove_empty(which = "cols") %>% colnames()

#variables to do fossil predictions with
pred_vars <- fdat_cln[c(9:83)]

#species in dataset
spp_obs <- dat$Taxon_Upham_style %>% unique()

#Color palette
pal = c('#62361B', '#f48a1a', '#e6ab02', '#66a61e', '#31c1bb', '#0d57ff', '#5e1ea6', '#f9581c' , '#f384f8')
```

### Load & Subset Models

Loading our list of log(Mass) models and selecting the ones for which we have fossil measurements. 

```{r}
list_b_lm <- read_rds(here("Data","B_lm_mods_mis.Rds"))
#purrr keep_at is great!
list_b2 <- list_b_lm %>% keep_at(pred_vars)

names(list_b2)

rm(list_b_lm)
```
Now, loop through (or purrr) models and predict the climbing scores for e


This only changes the intercept
```{r}
conditions <- data.frame(log_Mass = c(-1, 0, 1))

plot(conditional_effects(
     list_o2_lm$Ppl, 
     resp = "LocOrd2",
     effects  = "Ppl",
     conditions = conditions,
     categorical = TRUE
 ))
```
Model below

Now plot interactions from interaction model

```{r}
conditions <- data.frame(log_Mass = setNames(c(-2, 0, 2), c("Small", "Mean", "Large")))

plot(conditional_effects(m_ppl, 
     ndraws = 1000,
     resp = "LocOrd2",
     effects  = "Ppl",
     conditions = conditions,
     categorical = TRUE
 ))
```
```{r}
dat %>% ggplot(aes(x = log_Mass, y = Ppl, color = as.factor(Loc_bin))) + geom_point(size = 3, alpha = .8) + scale_color_brewer(palette = "Dark2")

dat %>% ggplot(aes(x = log_Mass, y = Ppl, color = Loc_Ord2)) + geom_point(size = 3, alpha = .8) + scale_color_brewer(palette = "Dark2")
```

Other Interactions
Use this Africa as an example
```{r warning = FALSE, message=FALSE}
data(rugged, package = "rethinking")
d <- rugged
rm(rugged)
dd <- 
  d %>%
  mutate(log_gdp = log(rgdppc_2000)) %>% 
# extract countries with GDP data
  filter(complete.cases(rgdppc_2000)) %>% 
  # re-scale variables
  mutate(log_gdp_std = log_gdp / mean(log_gdp), 
         rugged_std  = rugged / max(rugged))  %>% 
   mutate(rugged_std_c  = rugged_std - mean(rugged_std)) %>% 
  mutate(cid = if_else(cont_africa == 1, "1", "2"))

b8.3 <- brm(data = dd, 
      family = gaussian,
      bf(log_gdp_std ~ 0 + a + b * rugged_std_c, 
         a ~ 0 + cid, 
         b ~ 0 + cid,
         nl = TRUE),
      prior = c(prior(normal(1, 0.1), class = b, coef = cid1, nlpar = a),
                prior(normal(1, 0.1), class = b, coef = cid2, nlpar = a),
                prior(normal(0, 0.3), class = b, coef = cid1, nlpar = b),
                prior(normal(0, 0.3), class = b, coef = cid2, nlpar = b),
                prior(exponential(1), class = sigma)),
      iter = 2000, warmup = 1000, chains = 4, cores = 4)


nd <- 
  crossing(cid        = 1:2,
           rugged_std = seq(from = -0.2, to = 1.2, length.out = 30)) %>% 
  mutate(rugged_std_c = rugged_std - mean(dd$rugged_std))


f <-
  fitted(b8.3, 
         newdata = nd,
         probs = c(.015, .985)) %>%
  data.frame() %>%
  bind_cols(nd) %>%
  mutate(cont_africa = ifelse(cid == 1, "African nations", "Non-African nations"))

dd %>%
  mutate(cont_africa = ifelse(cont_africa == 1, "African nations", "Non-African nations")) %>%
  ggplot(aes(x = rugged_std, y = log_gdp_std, fill = cont_africa, color = cont_africa)) +
  geom_smooth(data = f,
              aes(y = Estimate, ymin = Q1.5, ymax = Q98.5),
              stat = "identity",
              alpha = 1/4, linewidth = 1/2) +
  geom_point(aes(y = log_gdp_std),
             size = 2/3) +
  labs(x = "ruggedness (standardized)",
       y = "log GDP (as proportion of mean)") +
  coord_cartesian(xlim = c(0, 1)) #+
  #theme(legend.position = "none") +
 # facet_wrap(~ cont_africa)
```

Can easily do this with ordinal groupings!
But do I want to? SHould I do this a different way? 
Isthe relationship between body mass and digit length different for each loc mode? Not sure if that is what I want to ask. 
```{r}
mm <- bf(log_Mass ~ 0 + a + b * Ppl, 
                       a ~ 0 + Loc_Ord2, 
                       b ~ 0 + Loc_Ord2,
                       nl = TRUE)


prior1 <- get_prior(data = dat, family = gaussian, formula = mm) %>%  mutate(prior = case_when(class == "b"  ~ "normal(0, 2)",class == "Intercept" ~ "normal(0, 1)", TRUE ~ prior ))
      
      
int_test <- brm(data = dat, 
      family = gaussian,
      bf(log_Mass ~ 0 + a + b * Ppl, 
         a ~ 0 + Loc_Ord2, 
         b ~ 0 + Loc_Ord2,
         nl = TRUE),
      prior = prior1,
      iter = 2000, warmup = 1000, chains = 4, cores = 4)

int_test
```

```{r}
plot(conditional_effects(int_test))
```

```{r}
prior2 <- get_prior(data = dat, family = gaussian, 
                    formula = bf(log_Mass ~ 0  + b * Ppl,
                                 b ~ 0 + Loc_Ord2,
                                 nl = TRUE)) %>%  
  mutate(prior = case_when(class == "b"  ~ "normal(0, 2)", TRUE ~ prior ))
      
int_test2 <- brm(data = dat, 
      family = gaussian,
      bf(log_Mass ~ 0  + b * Ppl, 
         #a ~ 0 + Loc_Ord2, 
         b ~ 0 + Loc_Ord2,
         nl = TRUE),
      prior = prior2,
      iter = 2000, warmup = 1000, chains = 4, cores = 4)

int_test2
```

```{r}
plot(conditional_effects(int_test2))
```



```{r}
nd <- 
  crossing(Loc_Ord2        = c("A","Sc", "T", "B"),
           Ppl = seq(from = -3, to = 3, length.out = 100))


f <-
  fitted(int_test, 
         newdata = nd,
         probs = c(.015, .985)) %>%
  data.frame() %>%
  bind_cols(nd) #%>%
 # mutate(cont_africa = ifelse(cid == 1, "African nations", "Non-African nations"))

dat %>%
  ggplot(aes(x = Ppl, y = log_Mass, fill = Loc_Ord2, color = Loc_Ord2)) +
  geom_smooth(data = f,
              aes(y = Estimate, ymin = Q1.5, ymax = Q98.5),
              stat = "identity",
              alpha = 1/4, linewidth = 2) +
  geom_point(aes(y = log_Mass)) + theme_bw() #+ coord_cartesian(xlim = c(-2, 2),
                                                               ylim = c(-2,2))
  #labs(x = "ruggedness (standardized)",
 #      y = "log GDP (as proportion of mean)") +
 # coord_cartesian(xlim = c(0, 1))
```



data(rugged, package = "rethinking")
d <- rugged
rm(rugged)

Interaction model - Ppl*log_Mass

```{r}
ord_mod <-  bf(Loc_Ord2 ~ mi(Ppl) * log_Mass + (1|Genus_species) + (1|gr(Taxon_Upham_style,cov = A))) + cumulative()

imp_mod <- bf(Ppl| mi() ~ log_Mass + Sl + Hl + Hsw + Hdw + Uol + Ul + Rl + Fl + Fsw + Fdw + Tl + Tmw + (1|gr(Taxon_Upham_style, cov = A))) + gaussian()

m_form <- ord_mod + imp_mod + set_rescor(FALSE)
  
pri <- get_prior(m_form,
                 data2 = list(A = A),
                 data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

m_ppl <- brm(m_form,
             data=dat,
             refresh = 0,
             cores = 4,
             data2 = list(A = A),
             prior = pri,
             seed = 145
             ) 

```

