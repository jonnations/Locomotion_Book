---
title: "Binary Classification"
output: html_notebook
---

Predicting binary climbing classifications (tree vs. ground) using postcranial measurements. Models will also incorperate intraspecific variation and phylogenetic variation.

# Preparation  

### Load packages and functions  
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, googlesheets4, brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))

source(here("Code","Name_Change.R"))
```
### Load data  

```{r message = FALSE, warning=FALSE}
dat <- read_sheet("https://docs.google.com/spreadsheets/d/1-eknhyZ1JNnXqhg2kViyzVntC8NGZvILQX-aQQb1Jvk/edit#gid=325036460", na = c("NA", "?", "")) %>%
  select(!NOTES) %>% 
# Recode Ordinal Rankings
  mutate(Loc_Ord = case_when(Loc_mode_Ordinal == "G"  ~ "G",
                             Loc_mode_Ordinal == "A"  ~ "A",
                             Loc_mode_Ordinal == "Sc" ~ "Sc",
                             Loc_mode_Ordinal == "T"  ~ "T",
                             Loc_mode_Ordinal == "Is" ~ "Is",
                             Loc_mode_Ordinal == "Sf" ~ "Sf",
                             Loc_mode_Ordinal == "Ss" ~ "Ss",
                             TRUE ~ NA),
         Loc_Ord = as.ordered(Loc_Ord),
         Loc_Ord = fct_relevel(Loc_Ord, c("G","A","Sc","T","Is","Sf","Ss")),
         # Combining the Intersurface and Semifossorial
         Loc_Ord2 = case_when(Loc_mode_Ordinal == "G" ~ "A",
                              Loc_mode_Ordinal == "A" ~ "A",
                              Loc_mode_Ordinal == "Sc" ~ "Sc",
                              Loc_mode_Ordinal == "T" ~ "T",
                              Loc_mode_Ordinal == "Is" ~ "B",
                              Loc_mode_Ordinal == "Sf" ~ "B",
                              Loc_mode_Ordinal == "Ss" ~ "B",
                             TRUE ~ NA),
         Loc_Ord2 = as.ordered(Loc_Ord2),
         Loc_Ord2 = fct_relevel(Loc_Ord2, c("B","T","Sc","A")),
         Loc_bin = case_when(Loc_mode_Bindary == "Ground" ~ 0,
                             Loc_mode_Bindary == "Tree" ~ 1,
                             TRUE ~ NA
                             ),
        # Loc_bin = as.factor(Loc_bin),
         Loc_mode_Categorical = as.factor(Loc_mode_Categorical),
         log_Mass = log(Mass_grams)) %>% 
    relocate(Loc_bin, .after = Loc_mode_Bindary) %>% 
  relocate(Loc_Ord, .after = Loc_mode_Ordinal) %>% 
  relocate(Loc_Ord2, .after = Loc_Ord) %>%
  relocate(log_Mass, .before = Skl) %>% 
#################
#Calculate Indices!
#################
  mutate(SI = Sh / Sl,             # Scapular Index
         HRI = Hsw / Hl,           # Humeral Robustness Index
         HPI = Hpw / Hl,           # Humeral Proximal Index
         HEB = Hdw / Hl,           # Humeral Epicondyle Breadth
         HHRI = Hhl / Hl,          # Humeral Head Robustness Index
         HHW = Hhw / Hhl,          # Humeral Head Shape Index
         DI = Hdcw / Hsw,          # Deltopectoral Crest Index
         OLI = Uol / Ul,           # Olecranon Process Length Index
         BI = Rl / Hl,             # Brachial Index
         IM = (Hl+Ul)/(Fl+Tl),     # Intermembral Index
         PRTI = Mcl/(Hl+Rl),       # Palm Robustness Index
         MRI = Mcw / Mcl,          # Metacarpal Robustness
         MANUS = Ppl / Mcl,        # MANUS index
         MANUS2 = (Ppl+Ipl)/Mcl,   # MANUS index with intermed. phalanx
         IRI = Fgh / Fl,           # Gluteal Index
         FRI = Fsw / Fl,           # Femoral Robustness
         FEB = Fdw / Fl,           # Femoral Epicondyle Breadth
         CI = Tl / Fl,             # Crural Index
         TRI = Tmw / Tl,           # Tibial Robustness Index
         #ANR = Anl / Al,          # Astragular Neck Robustness Index
         #CAR = Cal / Cl,          # Calcaneal Robustness Index
         IRI = Il / Pel,           # Illium Robustness Index
         PR = Il / Isl,            # Pelvic Index
         PES = Pppl / Mtl,         # PES INdex
         PES2 = (Pppl+Pipl)/Mtl    # PES with intermediate Phalanx
         ) %>% 
    # geometric mean
  drop_na(Tmw, Fdw, Tl, Fl, Fsw , Sl, Hdw, Hl, Hsw, Rl, Ul, Uol) %>%
  mutate(gm = ( Tmw * Fdw * Tl * Fl * Fsw * Sl * Hdw * Hl * Hsw * Rl * Ul * Uol)^(1/12)) %>%
  relocate(gm, .before = log_Mass) %>% 
  mutate_at(vars(19:73), log) %>% 
  mutate_at(vars(17:95), scale2)

spp_obs <- dat$Taxon_Upham_style %>% unique()

pal = c( '#62361B', '#e6ab02',  '#7570b3', '#66a61e')
```

### Load Tree & Get Cor Matrix

```{r}
tr <- ape::read.nexus(
  here("Data","MCC_Upham_all_mammals.nex"))
tr <- ape::keep.tip(tr, spp_obs)
A <- ape::vcv.phylo(tr, corr = TRUE)
```

## Description of Missing Data

*Linear measurements with complete data*
log_Mass, Sl, Sh, Hl, Hsw, Hdw, Uol, Ul, Rl, Fl, Fsw, Fdw, Tl, Tmw

Removing Sh from all analyses

*indices with complete data:*
 SI, HRI, HEB, OLI, BI, IM, FRI, FEB, CI, TRI
 
```{r}
var_complete <- c("log_Mass", "Sl", "Hl", "Hsw", "Hdw", "Uol", "Ul", "Rl", "Fl", "Fsw", "Fdw", "Tl", "Tmw", "SI", "HRI", "HEB", "OLI", "BI", "IM", "FRI", "FEB", "CI", "TRI")
```

*All variables with <= 31% missing data:*
MANUS2, Ipl, PES, Pppl, Mtl, MANUS, Ppl, Mcl, PRTI
These variables will be included in the study, and missing values will be imputed.
We added in a few more with between 30-50 missing data because they are good measurements:
Tpw, Isl, Il, Pel, Hpw, HPI, Mcw, MRI, Ppw, PES2, CI
```{r}
var_missing <- c("MANUS2", "Ipl", "PES", "Pppl", "Mtl", "MANUS", "Ppl", "Mcl", "PRTI", "Tpw", "Isl", "Il", "Pel", "Hpw", "HPI", "Mcw", "MRI", "Ppw", "PES2", "Cl")
```
*All variables with > 31% missing data:*
Pdpw, Dpw, Pipw, Pdpl, Cal, Anl, Atw, Csw, Ccw, Ctl, Ctw, Al, Jl, Ipw, Dpl, Pppw, Skl, Mtw, Fbdw, Fhd, Fgh, Fbmw, Hhw, Hhl, HHRI, HHW, *Cl*, Fbpw, Pipl, *PES2*, *Ppw*, *Mcw*, *MRI*, *Hpw*, *Pel*, *Il*, *Isl*, *Tpw*, Fbl, *HPI*, IRI, PR, Hdcw, DI, Tdw

```{r}
var_missing_complete <- c("MANUS2", "Ipl", "PES", "Pppl", "Mtl", "MANUS", "Ppl", "Mcl", "PRTI", "Tpw", "Isl", "Il", "Pel", "Hpw", "HPI", "Mcw", "MRI", "Ppw", "PES2", "Cl", "Pdpw", "Dpw", "Pipw", "Pdpl", "Cal", "Anl", "Atw", "Csw", "Ccw", "Ctl", "Ctw", "Al", "Jl", "Ipw", "Dpl", "Pppw", "Skl", "Mtw", "Fbdw", "Fhd", "Fgh", "Fbmw", "Hhw", "Hhl", "HHRI", "HHW", "Cl", "Fbpw", "Pipl", "PES2", "Ppw", "Mcw", "MRI", "Hpw", "Pel", "Il", "Isl", "Tpw", "Fbl", "HPI", "IRI", "PR", "Hdcw", "DI", "Tdw")

var_complete <- c("log_Mass", "Sl", "Hl", "Hsw", "Hdw", "Uol", "Ul", "Rl", "Fl", "Fsw", "Fdw", "Tl", "Tmw", "SI", "HRI", "HEB", "OLI", "BI", "IM", "FRI", "FEB", "CI", "TRI")

var_complete %>% write_rds(here("Data", "var_complete.Rds"))
var_missing %>% write_rds(here("Data", "var_missing.Rds"))
```



The percentages are stored in the df `Missing_Data_Percents.csv`

# Fit Models

## Log(Mass) Complete  

#### Prior  
```{r message = FALSE, warning=FALSE, include = FALSE}

p1 <- get_prior(Loc_bin ~ Sl + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
  data2 = list(A = A),
           family = bernoulli(),
           data = dat) %>% 
    mutate(
      prior = case_when(
        class == "b"  ~ "normal(0, 1)",
        class == "sd" ~ "normal(0, 1)",
        class == "Intercept" ~ "normal(0, 1)",
        TRUE ~ prior
      )
    )

p1 = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1), class = b),
                prior(normal(0, 1), class = sd))
```

#### Prelim model  

```{r message = FALSE, warning=FALSE, include = FALSE, cache=TRUE}
#initial fit
mm <- brm(Loc_bin ~ Sl + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = dat, refresh = 0, cores = 4,
          prior = p1)
```

#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

list_b_lm <- vector(mode ="list")

for(i in var_complete){
  list_b_lm[[i]]<- update(mm,
                         formula=(paste0("Loc_bin ~", i, "+log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A))")),
                         family = bernoulli(),
                         newdata=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = p1,
                         seed = 145
                         ) 
}

```


## Missing log(Mass)

Update cannot be used with multivatiate models

Prior must be called in the loop


#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

for(i in var_missing){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")+log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A))")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 1)",
      class == "sd" ~ "normal(0, 1)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm %>% write_rds(here("Data","B_lm_mods_mis.Rds"))
```


# Fit Models

## Geometric Mean Complete  

#### Prior  
```{r message = FALSE, warning=FALSE, include = FALSE}

p1 <- get_prior(Loc_bin ~ Sl + gm + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
  data2 = list(A = A),
           family = bernoulli(),
           data = dat) %>% 
    mutate(
      prior = case_when(
        class == "b"  ~ "normal(0, 1)",
        class == "sd" ~ "normal(0, 1)",
        class == "Intercept" ~ "normal(0, 1)",
        TRUE ~ prior
      )
    )

p1 = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1), class = b),
                prior(normal(0, 1), class = sd))
```

#### Prelim model  

```{r message = FALSE, warning=FALSE, include = FALSE, cache=TRUE}
#initial fit
mm <- brm(Loc_bin ~ Sl + gm + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = dat, refresh = 0, cores = 4,
          prior = p1)
```

#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

list_b_gm <- vector(mode ="list")

for(i in var_complete){
  list_b_gm[[i]]<- update(mm,
                         formula=(paste0("Loc_bin ~", i, "+gm+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A))")),
                         family = bernoulli(),
                         newdata=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = p1,
                         seed = 145
                         ) 
}

```


## Missing GM

Update cannot be used with multivariate models

Prior must be called in the loop


#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

for(i in var_missing){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")+gm+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A))")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ gm + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 1)",
      class == "sd" ~ "normal(0, 1)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_gm[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_gm %>% write_rds(here("Data","B_gm_mods_mis.Rds"))
```










