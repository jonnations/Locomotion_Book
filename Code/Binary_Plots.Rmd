---
title: "Binary Plots"
output: html_notebook
---

Plotting the Binary Model results

There are two parts: Probability plots and Forest Plots

Packages and Data
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, googlesheets4, brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()

# Models

list_o2_lm <- read_rds(here("Data","binary_lm_models.Rds"))
list_o2_gm <- read_rds(here("Data","binary_gm_models.Rds"))
```

data 
```{r message = FALSE, warning=FALSE}
dat <- read_sheet("https://docs.google.com/spreadsheets/d/1-eknhyZ1JNnXqhg2kViyzVntC8NGZvILQX-aQQb1Jvk/edit#gid=325036460", na = c("NA", "?", "")) %>%
  select(!NOTES) %>% 
# Recode Ordinal Rankings
  mutate(Loc_Ord = case_when(Loc_mode_Ordinal == "G"  ~ "G",
                             Loc_mode_Ordinal == "A"  ~ "A",
                             Loc_mode_Ordinal == "Sc" ~ "Sc",
                             Loc_mode_Ordinal == "T"  ~ "T",
                             Loc_mode_Ordinal == "Is" ~ "Is",
                             Loc_mode_Ordinal == "Sf" ~ "Sf",
                             Loc_mode_Ordinal == "Ss" ~ "Ss",
                             TRUE ~ NA),
         Loc_Ord = as.ordered(Loc_Ord),
         Loc_Ord = fct_relevel(Loc_Ord, c("G","A","Sc","T","Is","Sf","Ss")),
         # Combining the Intersurface and Semifossorial
         Loc_Ord2 = case_when(Loc_mode_Ordinal == "G" ~ "G",
                              Loc_mode_Ordinal == "A" ~ "A",
                              Loc_mode_Ordinal == "Sc" ~ "Sc",
                              Loc_mode_Ordinal == "T" ~ "T",
                              Loc_mode_Ordinal == "Is" ~ "Sf",
                              Loc_mode_Ordinal == "Sf" ~ "Sf",
                              Loc_mode_Ordinal == "Ss" ~ "Ss",
                             TRUE ~ NA),
         Loc_Ord2 = as.ordered(Loc_Ord2),
         Loc_Ord2 = fct_relevel(Loc_Ord2, c("G","A","Sc","T","Sf","Ss")),
         Loc_bin = case_when(Loc_mode_Bindary == "Ground" ~ 0,
                             Loc_mode_Bindary == "Tree" ~ 1,
                             TRUE ~ NA
                             ),
        # Loc_bin = as.factor(Loc_bin),
         Loc_mode_Categorical = as.factor(Loc_mode_Categorical),
         log_Mass = log(Mass_grams)) %>% 
    relocate(Loc_bin, .after = Loc_mode_Bindary) %>% 
  relocate(Loc_Ord, .after = Loc_mode_Ordinal) %>% 
  relocate(Loc_Ord2, .after = Loc_Ord) %>%
  relocate(log_Mass, .before = Skl) %>% 
#################
#Calculate Indices!
#################
  mutate(SI = Sh / Sl,             # Scapular Index
         HRI = Hsw / Hl,           # Humeral Robustness Index
         HPI = Hpw / Hl,           # Humeral Proximal Index
         HEB = Hdw / Hl,           # Humeral Epicondyle Breadth
         HHRI = Hhl / Hl,          # Humeral Head Robustness Index
         HHW = Hhw / Hhl,          # Humeral Head Shape Index
         DI = Hdcw / Hsw,          # Deltopectoral Crest Index
         OLI = Uol / Ul,           # Olecranon Process Length Index
         BI = Rl / Hl,             # Brachial Index
         IM = (Hl+Ul)/(Fl+Tl),     # Intermembral Index
         PRTI = Mcl/(Hl+Rl),       # Palm Robustness Index
         MRI = Mcw / Mcl,          # Metacarpal Robustness
         MANUS = Ppl / Mcl,        # MANUS index
         MANUS2 = (Ppl+Ipl)/Mcl,   # MANUS index with intermed. phalanx
         IRI = Fgh / Fl,           # Gluteal Index
         FRI = Fsw / Fl,           # Femoral Robustness
         FEB = Fdw / Fl,           # Femoral Epicondyle Breadth
         CI = Tl / Fl,             # Crural Index
         TRI = Tmw / Tl,           # Tibial Robustness Index
         #ANR = Anl / Al,          # Astragular Neck Robustness Index
         #CAR = Cal / Cl,          # Calcaneal Robustness Index
         IRI = Il / Pel,           # Illium Robustness Index
         PR = Il / Isl,            # Pelvic Index
         PES = Pppl / Mtl,         # PES INdex
         PES2 = (Pppl+Pipl)/Mtl    # PES with intermediate Phalanx
         ) %>% 
    # geometric mean
  drop_na(Tmw, Fdw, Tl, Fl, Fsw , Sh, Sl, Hdw, Hl, Hsw, Rl, Ul, Uol) %>%
  mutate(gm = ( Tmw * Fdw * Tl * Fl * Fsw  * Sh * Sl * Hdw * Hl * Hsw * Rl * Ul * Uol)^(1/13)) %>%
  relocate(gm, .before = log_Mass) %>% 
  mutate_at(vars(19:73), log) %>% 
  mutate_at(vars(17:95), scale2)

spp_obs <- dat$Taxon_Upham_style %>% unique()
```


some colors
```{r}
pal = c('#66a61e', '#7570b3',  '#e6ab02', '#62361B')

binpal = c('#66a61e','#5e1ea6')#5e1ea6

cols = c("#7570b3" ,  "#85D4E3" , "#0D7E9A",'#f5f5cb', '#c7e6d4', '#8cd2cd', '#55c3cf', '#3fa4b0', '#187389','#f48a1a', '#e6ab02', '#66a61e', '#85D4E3', '#0D7E9A', '#7570b3','#f6d03d', '#fe7b30', '#ef4a27', '#f384f8', '#625afc', '#0d57ff', '#47a7ff','#5771ff', '#6bae9e', '#31c1bb', '#7af1e1', '#d5e1af', '#f48130','#C60C30', '#00A1DE', '#62361B', '#009B3A', '#f9581c', '#522398', '#E27EA6', '#F9E300', '#565A5C')
```

# Forest Plots

Here i'm focusing on the slope of the phenotype

## Extract Slopes  

#### Helper Functions
```{r message = FALSE, warning=FALSE}
# Function -> pulls the th column, b_ or the slope, then pivots in long, and scales it to probability
cln <- function(df) as_draws_df(df)[2] %>% gather(var, val) %>% mutate(val = inv_logit_scaled(val))
```

#### Log_mass Slope DF
```{r message = FALSE, warning=FALSE}
#run  model
lms <- map(list_o2_lm, cln) %>% 
  bind_rows()

#list of slopes in order of means
nms <- lms %>% group_by(var) %>% summarise(mean = mean(val)) %>% arrange(mean) %>%  select(var)

# New df to demonstrate which vars don't overlap 0 at 89%
sigs_lm <- lms %>% group_by(var) %>% median_qi(val - 0.5, .width = c(0.89)) %>% 
  mutate(sigs = case_when(
    .lower > 0 & .upper > 0 ~ "sig",
    .lower < 0 & .upper < 0 ~ "sig",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
   mutate(dirs = case_when(
    .lower > 0 & .upper > 0 ~ "More Climbing = Larger Measurement",
    .lower < 0 & .upper < 0 ~ "More Climbing = Shorter Measurement",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
  select(var, sigs, dirs)
```

List the variables that have strong non-zero slopes
```{r}
sigs_lm %>% filter(sigs == "sig") %>% select(var) %>% as.list(var)
```

#### Geometric_mean Slope DF  

```{r message = FALSE, warning=FALSE}
#run  model
gms <- map(list_o2_gm, cln) %>% 
  bind_rows()

#list of slopes in order of means
nms_gm <- gms %>% group_by(var) %>% summarise(mean = mean(val)) %>% arrange(mean) %>%  select(var)

# New df to demonstrate which vars don't overlap 0 at 89%
sigs_gm <- gms %>% group_by(var) %>% median_qi(val - 0.5, .width = c(0.89)) %>% 
  mutate(sigs = case_when(
    .lower > 0 & .upper > 0 ~ "sig",
    .lower < 0 & .upper < 0 ~ "sig",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
 mutate(dirs = case_when(
    .lower > 0 & .upper > 0 ~ "More Climbing = Larger Measurement",
    .lower < 0 & .upper < 0 ~ "More Climbing = Shorter Measurement",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
  select(var, sigs, dirs)
```

## Plot Slopes

#### All LM Slopes
```{r warning = FALSE}

lms %>% right_join(sigs_lm, by = 'var') %>% 
  mutate(var = fct_relevel(var, nms$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs.pdf"), height = 15)

lms %>% right_join(sigs_lm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
  mutate(var = fct_relevel(var, nms$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs2.pdf"), height = 10)
```

#### All GM Slopes  

```{r warning = FALSE}

gms %>% right_join(sigs_gm, by = 'var') %>% 
  mutate(var = fct_relevel(var, nms_gm$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs.pdf"), height = 15)

gms %>% right_join(sigs_gm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
  mutate(var = fct_relevel(var, nms_gm$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs2.pdf"), height = 10)
```

## Combined Forest Plot

Wrangle sigs from both DFs and rename
```{r}
lmsig <- lms %>% 
  right_join(sigs_lm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
 #mutate(dirs = case_when(
 #  val > 0.5  ~ "Decreasing",
 #  val < 0.5  ~ "Increasing")) %>% 
  mutate(correction = "log(Mass)")

sigplotdf <- gms %>% 
  right_join(sigs_gm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
 #mutate(dirs = case_when(
 #  val > 0.5  ~ "Decreasing",
 #  val < 0.5  ~ "Increasing")) %>% 
  mutate(correction = "Geometric Mean") %>% 
  bind_rows(lmsig)

rm(lmsig)


sigplotdf <- sigplotdf %>% 
  mutate(var = case_when(var == "b_Hl"  ~ "Humerus Length",
                         var == "b_Uol"  ~ "Olecranon Length",
                         var == "b_Rl" ~ "Radius Length",
                         var == "b_Fl"  ~ "Femur Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length",
                         var == "b_Ipl" ~ "Intermediate Phalanx Length",
                         var == "b_Ipw"  ~ "Intermediate Phalanx Width",
                         var == "b_Dpl"  ~ "Distal Phalanx Length",
                         var == "b_Dpw" ~ "Distal Phalanx Length",
                         var == "b_Mtl"  ~ "Metatarsal Length",
                         var == "b_Mtw" ~ "Metatarsal Width",
                         var == "b_Pipl" ~ "Intermediate Phalanx Length Pes",
                         var == "b_Pipw" ~ "Intermediate Phalanx Width Pes",
                         var == "b_HRI" ~ "Humeral Robustness Index",
                         var == "b_HPI" ~ "Proximal Humeral Index",
                         var == "b_HEB" ~ "Humeral Epicondyle Index",
                         var == "b_HHRI" ~ "Humeral Head Index",
                         var == "b_OLI"  ~ "Olecranon Process Index",
                         var == "b_PRTI"  ~ "Palm Robustness Index",
                         var == "b_MANUS" ~ "Manus Proportion Index Proximal",
                         var == "b_MANUS2"  ~ "Manus Proportion Index Intermediate",
                         var == "b_IRI" ~ "Illium Robustness Index",
                         var == "b_FRI" ~ "Femoral Robustness Index",
                         var == "b_FEB" ~ "Femoral Epicondyle Index",
                         var == "b_CI" ~ "Crural Index",
                         var == "b_TRI"  ~ "Tibial Robustness Index",
                         var == "b_PR"  ~ "Pelvic Index",
                         var == "b_PES" ~ "Pes Proportion Index Proximal",
                         var == "b_PES2"  ~ "Pes Proportion Index Intermediate",
                         var == "b_Ul" ~ "Ulna Length",
                         var == "b_Cal" ~ "Calcaneal Body Length",
                         var == "b_Anl" ~ "Astragular Neck Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length Pes",
                         var == "b_Fbmw" ~ "Fibula Midshaft Diameter",
                         var == "b_Fhd" ~ "Femoral Head Diameter",
                         var == "b_HHW" ~ "Humeral Head Index",
                         var == "b_IM" ~ "Intermembral Index",
                         var == "b_MRI" ~ "Metacarpal Robustness Index",
                         var == "b_Hhl" ~ "Humeral Head Length",
                         var == "b_Fbl" ~ "Fibula Length",
                         TRUE ~ NA)) 

levs <- c("Humeral Head Index", "Intermediate Phalanx Width Pes", "Metatarsal Width", "Metacarpal Robustness Index", "Tibial Robustness Index", "Humeral Head Index", "Intermediate Phalanx Width", "Distal Phalanx Length", "Distal Phalanx Length", "Humeral Robustness Index", "Palm Robustness Index", "Metatarsal Length", "Humeral Epicondyle Index", "Olecranon Length", "Crural Index", "Femoral Robustness Index", "Femoral Epicondyle Index", "Olecranon Process Index", "Proximal Humeral Index", NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "Fibula Length", NA, "Intermembral Index", "Calcaneal Body Length", "Fibula Midshaft Diameter", "Femoral Head Diameter", "Ulna Length", "Humeral Head Length", "Femur Length", "Manus Proportion Index Intermediate", "Intermediate Phalanx Length Pes", "Pelvic Index", "Astragular Neck Length", "Illium Robustness Index", "Radius Length", "Humerus Length", "Intermediate Phalanx Length", "Manus Proportion Index Proximal", "Pes Proportion Index Intermediate", "Pes Proportion Index Proximal", "Proximal Phalanx Length")
```

```{r}
nms2 <- nms %>% mutate(var = case_when(var == "b_Hl"  ~ "Humerus Length",
                         var == "b_Uol"  ~ "Olecranon Length",
                         var == "b_Rl" ~ "Radius Length",
                         var == "b_Fl"  ~ "Femur Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length",
                         var == "b_Ipl" ~ "Intermediate Phalanx Length",
                         var == "b_Ipw"  ~ "Intermediate Phalanx Width",
                         var == "b_Dpl"  ~ "Distal Phalanx Length",
                         var == "b_Dpw" ~ "Distal Phalanx Length",
                         var == "b_Mtl"  ~ "Metatarsal Length",
                         var == "b_Mtw" ~ "Metatarsal Width",
                         var == "b_Pipl" ~ "Intermediate Phalanx Length Pes",
                         var == "b_Pipw" ~ "Intermediate Phalanx Width Pes",
                         var == "b_HRI" ~ "Humeral Robustness Index",
                         var == "b_HPI" ~ "Proximal Humeral Index",
                         var == "b_HEB" ~ "Humeral Epicondyle Index",
                         var == "b_HHRI" ~ "Humeral Head Index",
                         var == "b_OLI"  ~ "Olecranon Process Index",
                         var == "b_PRTI"  ~ "Palm Robustness Index",
                         var == "b_MANUS" ~ "Manus Proportion Index Proximal",
                         var == "b_MANUS2"  ~ "Manus Proportion Index Intermediate",
                         var == "b_IRI" ~ "Illium Robustness Index",
                         var == "b_FRI" ~ "Femoral Robustness Index",
                         var == "b_FEB" ~ "Femoral Epicondyle Index",
                         var == "b_CI" ~ "Crural Index",
                         var == "b_TRI"  ~ "Tibial Robustness Index",
                         var == "b_PR"  ~ "Pelvic Index",
                         var == "b_PES" ~ "Pes Proportion Index Proximal",
                         var == "b_PES2"  ~ "Pes Proportion Index Intermediate",
                         var == "b_Ul" ~ "Ulna Length",
                         var == "b_Cal" ~ "Calcaneal Body Length",
                         var == "b_Anl" ~ "Astragular Neck Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length Pes",
                         var == "b_Fbmw" ~ "Fibula Midshaft Diameter",
                         var == "b_Fhd" ~ "Femoral Head Diameter",
                         var == "b_HHW" ~ "Humeral Head Index",
                         var == "b_IM" ~ "Intermembral Index",
                         var == "b_MRI" ~ "Metacarpal Robustness Index",
                         var == "b_Hhl" ~ "Humeral Head Length",
                         var == "b_Fbl" ~ "Fibula Length",
                         TRUE ~ NA)) 
```



#### Big Forest Plot  
```{r}

sigplotdf %>% 
  mutate(var = fct_relevel(var, levs)) %>%
  ggplot(aes(x = val, y = var, color = correction)) + 
  stat_pointinterval(.width = c(.66, .89), position = position_dodge(width = .5)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = binpal) +
  scale_color_manual(values = binpal) +
  theme_bw(base_size = 14) +
  labs(title = "Binary Modeling: Effect Sizes",
       subtitle = "The further the estimates are from 0.5, the stronger the effect of the measurement on climbing.\nMeasurements on the left side decrease with decreased climbing (e.g. shorter olecranon)\nand values on the right increase with increased climbing ( e.g. longer phalanges)",
       x = "log-odds",
       y = "") +
  facet_wrap(~fct_relevel(dirs,'More Climbing = Shorter Measurement','More Climbing = Larger Measurement'), scales = "free")

ggsave(here("Plots/Binary_Modeling_Effects.pdf"), height = 9, width = 14)
ggsave(here("Plots","Binary_Modeling_Effects.png"), height = 9, width = 14)
```



# Probability Plots 


### Four plots for comparisons 

Plot the 4 "best" predictors: Ppl, PES, HPI, and OLI
These are the SAME as the ordinal models!

```{r}
p1 <- plot(conditional_effects(list_o2_lm$Ppl,  prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)+ ylim(0,1) + xlim(NA, 4)

p2 <- plot(conditional_effects(list_o2_lm$PES,  prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

p3 <- plot(conditional_effects(list_o2_lm$HPI,  prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

p4 <- plot(conditional_effects(list_o2_lm$OLI,  prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

(p1 + p2) / (p3 + p4) + plot_layout(guides = "collect") + plot_annotation(title = "Measurements with the largest effect sizes") & theme_bw()

ggsave( here("Plots","Bin_compare_1.pdf"), width = 8, height = 5)
ggsave( here("Plots","Bin_compare_1.png"), width = 8, height = 5)
```



```{r warning = F}
p1 <- as.data.frame(conditional_effects(list_o2_lm$Ppl,  prob = 0.89, points = TRUE)$'Ppl') %>% 
  ggplot(aes(x=Ppl,y=estimate__)) + 
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.2, fill = "#5e1ea6") +
  geom_line(color = "#5e1ea6", linewidth = 1.3)+
  labs(y="Probability",x="Ppl") + 
      geom_point(aes(x = Ppl, y = Loc_bin), data = dat) +
                   theme_bw()

p2 <- as.data.frame(conditional_effects(list_o2_lm$PES,  prob = 0.89, points = TRUE)$'PES') %>% 
  ggplot(aes(x=PES,y=estimate__)) + 
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.2, fill = "#5e1ea6") +
  geom_line(color = "#5e1ea6", linewidth = 1.3)+
  labs(y="Probability",x="PES") + 
      geom_point(aes(x = PES, y = Loc_bin), data = dat) +
                   theme_bw()

p3 <- as.data.frame(conditional_effects(list_o2_lm$HPI,  prob = 0.89, points = TRUE)$'HPI') %>% 
  ggplot(aes(x=HPI,y=estimate__)) + 
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.2, fill = "#5e1ea6") +
  geom_line(color = "#5e1ea6", linewidth = 1.3)+
  labs(y="Probability",x="HPI") + 
      geom_point(aes(x = HPI, y = Loc_bin), data = dat) +
                   theme_bw()

p4 <- as.data.frame(conditional_effects(list_o2_lm$OLI,  prob = 0.89, points = TRUE)$'OLI') %>% 
  ggplot(aes(x=OLI,y=estimate__)) + 
  geom_ribbon(aes(ymin=lower__, ymax=upper__), alpha=0.2, fill = "#62361B") +
  geom_line(color = "#62361B", linewidth = 1.3)+
  labs(y="Probability",x="OLI") + 
      geom_point(aes(x = OLI, y = Loc_bin), data = dat) +
                   theme_bw()

(p1 + p2) / (p3 + p4) + plot_layout(guides = "collect") + plot_annotation(title = "Measurements with the largest effect sizes") & theme_bw()

ggsave( here("Plots","Bin_compare_1.pdf"), width = 8, height = 5)
ggsave( here("Plots","Bin_compare_1.png"), width = 8, height = 5)
```

