---
title: "Binary Plots"
output: html_notebook
---

Plotting the Binary Model results

There are two parts: Probability plots and Forest Plots

Packages and Data
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, googlesheets4, brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue, ggthemes)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))

source(here("Code","Name_Change.R"))

# Models

list_b_lm <- read_rds(here("Data","B_lm_mods_mis.Rds"))
list_b_gm <- read_rds(here("Data","B_gm_mods_mis.Rds"))
```



some colors
```{r}
pal = c('#66a61e', '#7570b3',  '#e6ab02', '#62361B')

binpal = c('#66a61e','#5e1ea6')#5e1ea6

cols = c("#7570b3" ,  "#85D4E3" , "#0D7E9A",'#f5f5cb', '#c7e6d4', '#8cd2cd', '#55c3cf', '#3fa4b0', '#187389','#f48a1a', '#e6ab02', '#66a61e', '#85D4E3', '#0D7E9A', '#7570b3','#f6d03d', '#fe7b30', '#ef4a27', '#f384f8', '#625afc', '#0d57ff', '#47a7ff','#5771ff', '#6bae9e', '#31c1bb', '#7af1e1', '#d5e1af', '#f48130','#C60C30', '#00A1DE', '#62361B', '#009B3A', '#f9581c', '#522398', '#E27EA6', '#F9E300', '#565A5C')
```

# Forest Plots

Here i'm focusing on the slope of the phenotype

## Extract Slopes  

#### Helper Functions

```{r message = FALSE, warning=FALSE}
# Function -> pulls the th column, b_ or the slope, then pivots in long, and scales it to probability
cln <- function(df) as_draws_df(df)[2] %>% gather(var, val) %>% mutate(val = inv_logit_scaled(val))
# Same for missing
cln2 <- function(df) as_draws_df(df)[17] %>% gather(var, val) %>% mutate(val = inv_logit_scaled(val))
```

```{r message = FALSE, warning=FALSE}
# Function -> pulls the th column, b_ or the slope, then pivots in long, and scales it to probability
lms <- map(list_b_lm[2:23], cln) %>% 
  bind_rows() %>% mutate(var = str_replace(var, "b_",""))

lms2 <- map(list_b_lm[24:44], cln2) %>% 
  bind_rows() %>% mutate(var = str_replace(var, "bsp_Locbin_mi",""))

lms <- lms %>% bind_rows(lms2)
rm(lms2)
```

#### Log_mass Slope DF
```{r message = FALSE, warning=FALSE}
#list of slopes in order of means
nms <- lms %>% group_by(var) %>% summarise(mean = mean(val)) %>% arrange(mean) %>%  select(var)

m <- as.factor(nms$var)
m <- fct_rev(m)
m %>% saveRDS(here("Data", "Order_Names.Rds"))

# New df to demonstrate which vars don't overlap 0 at 89%
sigs_lm <- lms %>% group_by(var) %>% median_qi(val - 0.5, .width = c(0.89)) %>% 
  mutate(sigs = case_when(
    .lower > 0 & .upper > 0 ~ "sig",
    .lower < 0 & .upper < 0 ~ "sig",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
   mutate(dirs = case_when(
    .lower > 0 & .upper > 0 ~ "More Climbing = Larger Measurement",
    .lower < 0 & .upper < 0 ~ "More Climbing = Shorter Measurement",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
  select(var, sigs, dirs)
```

List the variables that have strong non-zero slopes
```{r}
sigs_lm %>% filter(sigs == "sig") %>% select(var) %>% as.list(var)
```

#### Geometric_mean Slope DF  

```{r message = FALSE, warning=FALSE}

# Function -> pulls the th column, b_ or the slope, then pivots in long, and scales it to probability
gms <- map(list_b_gm[2:23], cln) %>% 
  bind_rows() %>% mutate(var = str_replace(var, "b_",""))

gms2 <- map(list_b_gm[24:44], cln2) %>% 
  bind_rows() %>% mutate(var = str_replace(var, "bsp_Locbin_mi",""))

gms <- gms %>% bind_rows(gms2)
rm(gms2)


#list of slopes in order of means
nms_gm <- gms %>% group_by(var) %>% summarise(mean = mean(val)) %>% arrange(mean) %>%  select(var)

# New df to demonstrate which vars don't overlap 0 at 89%
sigs_gm <- gms %>% group_by(var) %>% median_qi(val - 0.5, .width = c(0.89)) %>% 
  mutate(sigs = case_when(
    .lower > 0 & .upper > 0 ~ "sig",
    .lower < 0 & .upper < 0 ~ "sig",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
 mutate(dirs = case_when(
    .lower > 0 & .upper > 0 ~ "More Climbing = Larger Measurement",
    .lower < 0 & .upper < 0 ~ "More Climbing = Shorter Measurement",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% 
  select(var, sigs, dirs)
```

## Plot Slopes

#### All LM Slopes
```{r warning = FALSE}

lms %>% right_join(sigs_lm, by = 'var') %>% 
  mutate(var = fct_relevel(var, nms$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs.pdf"), height = 15)

lms %>% right_join(sigs_lm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
  mutate(var = fct_relevel(var, nms$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs2.pdf"), height = 10)
```

#### All GM Slopes  

```{r warning = FALSE}

gms %>% right_join(sigs_gm, by = 'var') %>% 
  mutate(var = fct_relevel(var, nms_gm$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs.pdf"), height = 15)

gms %>% right_join(sigs_gm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
  mutate(var = fct_relevel(var, nms_gm$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

#ggsave(here("Plots","Ord2_sigs2.pdf"), height = 10)
```

## Combined Forest Plot

Wrangle sigs from both DFs and rename
```{r}
lmsig <- lms %>% 
  right_join(sigs_lm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
 #mutate(dirs = case_when(
 #  val > 0.5  ~ "Decreasing",
 #  val < 0.5  ~ "Increasing")) %>% 
  mutate(correction = "log(Mass)")

sigplotdf <- gms %>% 
  right_join(sigs_gm, by = 'var') %>% 
  filter(sigs == "sig") %>% 
 #mutate(dirs = case_when(
 #  val > 0.5  ~ "Decreasing",
 #  val < 0.5  ~ "Increasing")) %>% 
  mutate(correction = "Geometric Mean") %>% 
  bind_rows(lmsig)

rm(lmsig)


sigplotdf <- sigplotdf %>% 
  mutate(var = case_when(var == "b_Hl"  ~ "Humerus Length",
                         var == "b_Uol"  ~ "Olecranon Length",
                         var == "b_Rl" ~ "Radius Length",
                         var == "b_Fl"  ~ "Femur Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length",
                         var == "b_Ipl" ~ "Intermediate Phalanx Length",
                         var == "b_Ipw"  ~ "Intermediate Phalanx Width",
                         var == "b_Dpl"  ~ "Distal Phalanx Length",
                         var == "b_Dpw" ~ "Distal Phalanx Length",
                         var == "b_Mtl"  ~ "Metatarsal Length",
                         var == "b_Mtw" ~ "Metatarsal Width",
                         var == "b_Pipl" ~ "Intermediate Phalanx Length Pes",
                         var == "b_Pipw" ~ "Intermediate Phalanx Width Pes",
                         var == "b_HRI" ~ "Humeral Robustness Index",
                         var == "b_HPI" ~ "Proximal Humeral Index",
                         var == "b_HEB" ~ "Humeral Epicondyle Index",
                         var == "b_HHRI" ~ "Humeral Head Index",
                         var == "b_OLI"  ~ "Olecranon Process Index",
                         var == "b_PRTI"  ~ "Palm Robustness Index",
                         var == "b_MANUS" ~ "Manus Proportion Index Proximal",
                         var == "b_MANUS2"  ~ "Manus Proportion Index Intermediate",
                         var == "b_IRI" ~ "Illium Robustness Index",
                         var == "b_FRI" ~ "Femoral Robustness Index",
                         var == "b_FEB" ~ "Femoral Epicondyle Index",
                         var == "b_CI" ~ "Crural Index",
                         var == "b_TRI"  ~ "Tibial Robustness Index",
                         var == "b_PR"  ~ "Pelvic Index",
                         var == "b_PES" ~ "Pes Proportion Index Proximal",
                         var == "b_PES2"  ~ "Pes Proportion Index Intermediate",
                         var == "b_Ul" ~ "Ulna Length",
                         var == "b_Cal" ~ "Calcaneal Body Length",
                         var == "b_Anl" ~ "Astragular Neck Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length Pes",
                         var == "b_Fbmw" ~ "Fibula Midshaft Diameter",
                         var == "b_Fhd" ~ "Femoral Head Diameter",
                         var == "b_HHW" ~ "Humeral Head Index",
                         var == "b_IM" ~ "Intermembral Index",
                         var == "b_MRI" ~ "Metacarpal Robustness Index",
                         var == "b_Hhl" ~ "Humeral Head Length",
                         var == "b_Fbl" ~ "Fibula Length",
                         TRUE ~ NA)) 

levs <- c("Humeral Head Index", "Intermediate Phalanx Width Pes", "Metatarsal Width", "Metacarpal Robustness Index", "Tibial Robustness Index", "Humeral Head Index", "Intermediate Phalanx Width", "Distal Phalanx Length", "Distal Phalanx Length", "Humeral Robustness Index", "Palm Robustness Index", "Metatarsal Length", "Humeral Epicondyle Index", "Olecranon Length", "Crural Index", "Femoral Robustness Index", "Femoral Epicondyle Index", "Olecranon Process Index", "Proximal Humeral Index", NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "Fibula Length", NA, "Intermembral Index", "Calcaneal Body Length", "Fibula Midshaft Diameter", "Femoral Head Diameter", "Ulna Length", "Humeral Head Length", "Femur Length", "Manus Proportion Index Intermediate", "Intermediate Phalanx Length Pes", "Pelvic Index", "Astragular Neck Length", "Illium Robustness Index", "Radius Length", "Humerus Length", "Intermediate Phalanx Length", "Manus Proportion Index Proximal", "Pes Proportion Index Intermediate", "Pes Proportion Index Proximal", "Proximal Phalanx Length")
```

```{r}
nms2 <- nms %>% mutate(var = case_when(var == "b_Hl"  ~ "Humerus Length",
                         var == "b_Uol"  ~ "Olecranon Length",
                         var == "b_Rl" ~ "Radius Length",
                         var == "b_Fl"  ~ "Femur Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length",
                         var == "b_Ipl" ~ "Intermediate Phalanx Length",
                         var == "b_Ipw"  ~ "Intermediate Phalanx Width",
                         var == "b_Dpl"  ~ "Distal Phalanx Length",
                         var == "b_Dpw" ~ "Distal Phalanx Length",
                         var == "b_Mtl"  ~ "Metatarsal Length",
                         var == "b_Mtw" ~ "Metatarsal Width",
                         var == "b_Pipl" ~ "Intermediate Phalanx Length Pes",
                         var == "b_Pipw" ~ "Intermediate Phalanx Width Pes",
                         var == "b_HRI" ~ "Humeral Robustness Index",
                         var == "b_HPI" ~ "Proximal Humeral Index",
                         var == "b_HEB" ~ "Humeral Epicondyle Index",
                         var == "b_HHRI" ~ "Humeral Head Index",
                         var == "b_OLI"  ~ "Olecranon Process Index",
                         var == "b_PRTI"  ~ "Palm Robustness Index",
                         var == "b_MANUS" ~ "Manus Proportion Index Proximal",
                         var == "b_MANUS2"  ~ "Manus Proportion Index Intermediate",
                         var == "b_IRI" ~ "Illium Robustness Index",
                         var == "b_FRI" ~ "Femoral Robustness Index",
                         var == "b_FEB" ~ "Femoral Epicondyle Index",
                         var == "b_CI" ~ "Crural Index",
                         var == "b_TRI"  ~ "Tibial Robustness Index",
                         var == "b_PR"  ~ "Pelvic Index",
                         var == "b_PES" ~ "Pes Proportion Index Proximal",
                         var == "b_PES2"  ~ "Pes Proportion Index Intermediate",
                         var == "b_Ul" ~ "Ulna Length",
                         var == "b_Cal" ~ "Calcaneal Body Length",
                         var == "b_Anl" ~ "Astragular Neck Length",
                         var == "b_Ppl" ~ "Proximal Phalanx Length Pes",
                         var == "b_Fbmw" ~ "Fibula Midshaft Diameter",
                         var == "b_Fhd" ~ "Femoral Head Diameter",
                         var == "b_HHW" ~ "Humeral Head Index",
                         var == "b_IM" ~ "Intermembral Index",
                         var == "b_MRI" ~ "Metacarpal Robustness Index",
                         var == "b_Hhl" ~ "Humeral Head Length",
                         var == "b_Fbl" ~ "Fibula Length",
                         TRUE ~ NA)) 
```



#### Big Forest Plot  
```{r}

sigplotdf %>% 
  mutate(var = fct_relevel(var, levs)) %>%
  ggplot(aes(x = val, y = var, color = correction)) + 
  stat_pointinterval(.width = c(.66, .89), position = position_dodge(width = .5)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = binpal) +
  scale_color_manual(values = binpal) +
  theme_bw(base_size = 14) +
  labs(title = "Binary Modeling: Effect Sizes",
       subtitle = "The further the estimates are from 0.5, the stronger the effect of the measurement on climbing.\nMeasurements on the left side decrease with decreased climbing (e.g. shorter olecranon)\nand values on the right increase with increased climbing ( e.g. longer phalanges)",
       x = "log-odds",
       y = "") +
  facet_wrap(~fct_relevel(dirs,'More Climbing = Shorter Measurement','More Climbing = Larger Measurement'), scales = "free")

ggsave(here("Plots/Binary_Modeling_Effects.pdf"), height = 9, width = 14)
ggsave(here("Plots","Binary_Modeling_Effects.png"), height = 9, width = 14)
```

#Prob Faceting  

## LM

```{r}
sigs <- sigs_lm %>% filter(sigs == "sig") %>% select(var)
sigs <- sigs$var

#Has to be done in 2 parts because the mi() and non-mi() conditional effects are different.
misigs <- c("HPI", "Ipl", "MANUS", "MANUS2", "MRI", "Mtl", "PES", "PES2", "PRTI", "Ppl")

nomisigs <- c("CI", "FEB", "Fl", "FRI", "HEB", "HRI", "Hl", "IM",  "OLI", "Rl", "TRI", "Ul", "Uol")



```


```{r}
ttt2 <- list_b_lm[misigs]

tt2 <- map(ttt2, ~ conditional_effects(.,
                                       resp = "Locbin",
                                       prob = 0.89)[2] %>%
             as.data.frame() %>%
             rename_with(~str_remove(.,"^.*\\.")) %>%
             mutate(var = colnames(.)[1]) %>% 
             select(c("var", "effect1__", "estimate__", "cond__", "lower__", "upper__"))) %>%
  bind_rows() 

```

```{r}
ttt1 <- list_b_lm[nomisigs]

tt1 <- furrr::future_map(ttt1, ~ conditional_effects(.,  resp = "LocOrd2", prob = 0.89)[1] %>%
            as.data.frame() %>%
             rename_with(~str_remove(.,"^.*\\.")) %>%
             mutate(var = colnames(.)[1]) %>% 
             select(c("var", "effect1__", "estimate__", "cond__", "lower__", "upper__"))) %>%
  bind_rows()  

lm_res <- bind_rows(tt1, tt2)
```

plot

```{r}
lm_res %>% filter(var != "log_Mass") %>% ggplot(aes(x = effect1__, y = estimate__)) + 
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.25) +
  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.2)+
  geom_line(linewidth = 1, position = position_dodge(0.05)) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  labs(x = "", y = "Probability") +
  theme_bw() +
  theme(legend.position = c(1,0), # top left position
    legend.justification = c(3.5, 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()) +
  facet_wrap(~var, ncol = 6, scales = "free_x")
```
#### Fancier

```{r}
m <- as.factor(nms$var)
m <- fct_rev(m)
rect <- data.frame(xmin=-1.59819, xmax=1.59819, ymin=-Inf, ymax=Inf)
rect2 <- data.frame(xmin=-.974, xmax=.974, ymin=-Inf, ymax=Inf)
rect3 <- data.frame(xmin=-.67449, xmax=.67449, ymin=-Inf, ymax=Inf)
lm_res %>%ggplot(aes(x = effect1__, y = estimate__)) + 
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.25) +
  geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
    geom_rect(data=rect2, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
      geom_rect(data=rect3, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.2, fill = '#0D7E9A')+
  geom_line(linewidth = 1, position = position_dodge(0.05), color = '#0D7E9A') + 
  labs(x = "", y = "Probability") +
  theme_bw() +
  theme(legend.position = c(1,0), # top left position
    legend.justification = c(3.5, 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()) +
  facet_wrap(~fct_relevel(var, nms$var), ncol = 6, scales = "free_x")

ggsave(here("Plots","Bin_Plot.pdf"), height = 10, width = 10)
```


## GM

```{r}
sigs <- sigs_gm %>% filter(sigs == "sig") %>% select(var)
sigs <- sigs$var

#Has to be done in 2 parts because the mi() and non-mi() conditional effects are different.
misigs <- c("HPI", "Ipl", "MANUS", "MANUS2", "MRI", "Mtl", "PES", "PES2", "PRTI", "Ppl")

nomisigs <- c("CI", "FEB", "Fl", "FRI", "HEB", "HRI", "Hl", "IM",  "OLI", "Rl", "TRI", "Ul", "Uol")

```


```{r}
ttt2 <- list_b_gm[misigs]

tt2 <- map(ttt2, ~ conditional_effects(.,
                                       resp = "Locbin",
                                       prob = 0.89)[2] %>%
             as.data.frame() %>%
             rename_with(~str_remove(.,"^.*\\.")) %>%
             mutate(var = colnames(.)[1]) %>% 
             select(c("var", "effect1__", "estimate__", "cond__", "lower__", "upper__"))) %>%
  bind_rows() 

```

```{r}
ttt1 <- list_b_gm[nomisigs]

tt1 <- furrr::future_map(ttt1, ~ conditional_effects(.,  resp = "LocOrd2", prob = 0.89)[1] %>%
            as.data.frame() %>%
             rename_with(~str_remove(.,"^.*\\.")) %>%
             mutate(var = colnames(.)[1]) %>% 
             select(c("var", "effect1__", "estimate__", "cond__", "lower__", "upper__"))) %>%
  bind_rows()  

gm_res <- bind_rows(tt1, tt2)
```

plot

```{r}
gm_res %>% filter(var != "gm") %>% ggplot(aes(x = effect1__, y = estimate__)) + 
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.25) +
  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.2)+
  geom_line(linewidth = 1, position = position_dodge(0.05)) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  labs(x = "", y = "Probability") +
  theme_bw() +
  theme(legend.position = c(1,0), # top left position
    legend.justification = c(3.5, 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()) +
  facet_wrap(~var, ncol = 6, scales = "free_x")
```
#### Fancier

```{r}
m <- as.factor(nms$var)
m <- fct_rev(m)
rect <- data.frame(xmin = -0.67449, xmax = 0.67449, ymin=-Inf, ymax=Inf)
rect2 <- data.frame(xmin = -0.84162, xmax = 0.84162, ymin=-Inf, ymax=Inf)
rect3 <- data.frame(xmin = -1.03643, xmax = 1.03643, ymin=-Inf, ymax=Inf)
rect4 <- data.frame(xmin = -1.28155, xmax = 1.28155, ymin=-Inf, ymax=Inf)
rect5 <- data.frame(xmin = -1.64485, xmax =-1.64485, ymin=-Inf, ymax=Inf)
gm_res %>%ggplot(aes(x = effect1__, y = estimate__)) + 
  geom_vline(xintercept = 0, linetype = 2, linewidth = 0.25) +
  geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
    geom_rect(data=rect2, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
      geom_rect(data=rect3, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
  geom_rect(data=rect4, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
  geom_rect(data=rect5, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.1,
              inherit.aes = FALSE) +
  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.2, fill = '#009B3A')+
  geom_line(linewidth = 1, position = position_dodge(0.05), color = '#009B3A') + 
  labs(x = "", y = "Probability") +
  #xlim(-2.5, 2.5) +
  theme_bw() +
  theme(legend.position = c(1,0), # top left position
    legend.justification = c(3.5, 0),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()) +
  facet_wrap(~fct_relevel(var, nms$var), ncol = 6, scales = "free_x")

ggsave(here("Plots","Bin_Plot_GM.pdf"), height = 10, width = 10)
```


# Prob Facet Combo

Printing a plot like this with both GM and LM curves.
Need to combine those dataframes, then create another column of `control` (LM or GM), then plot, and color, fill, and linetype by control. May be too much information, so perhaps I can only do one ribbon and two lines?

```{r}
lm_res <- lm_res %>% mutate(cond = "lm")
gm_res <- gm_res %>% mutate(cond = "gm")

all_res <- bind_rows(lm_res, gm_res) %>% nm_change()
```

This is great!
Getting there. Things to do:
Individual xlim for each facet using ggh4x - -5 and 5 for all.
Change x axis breaks: -4, -2, 0, 2, 4 (?)
Change y axis breaks: 0, 0.5, 1
Rename all variables - code exists for other plot! Should be easy. this should actually be a function!
Remove grey facet headers. 

```{r}
nms2 <- nm_change(nms) %>% drop_na()

m <- as.factor(nms2$var)
m <- fct_rev(m)
n = 20
a = seq(from = -0.01, to = - 1.64485, length.out = n)
b = seq(from = 0.01, to =  1.64485, length.out = n)
c = rep(-Inf, times = n)
d = rep(Inf, times = n)
rect <- data.frame(xmin = a, xmax = b, ymin = c, ymax = d)

all_res %>% ggplot(aes(x = effect1__, y = estimate__)) + 
  #geom_vline(xintercept = 0, linetype = 2, linewidth = 0.25) +
    geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              alpha=0.035,
              inherit.aes = FALSE) +
  geom_ribbon(aes(ymin = lower__, ymax = upper__, fill = cond), alpha = 0.18)+
  geom_line(aes(color = cond, linetype = cond),linewidth = 0.5, position = position_dodge(0.05)) + 
  labs(x = "", y = "Probability") +
  scale_colour_manual(
   values = c('#009B3A', '#0D7E9A'),
   name = "Mass\nCorrection"
  ) +
    scale_fill_manual(
   values = c('#009B3A', '#0D7E9A'),
   name = "Mass\nCorrection"
  ) +
    scale_linetype_manual(
   values = c(1, 2),
   name = "Mass\nCorrection"
  ) +
  #xlim(-2.5, 2.5) +
  theme_pander() +
 theme(
   legend.position = c(1,0), # top left position
   legend.justification = c(1.4, -0.5),
   panel.grid.major = element_blank(),
   panel.grid.minor = element_blank(),
   strip.text.x = element_text(size = 8),
   axis.text.x=element_text(size = 6),
   axis.text.y=element_text(size = 6),
   #element_text(family = "Times"),
   panel.background = element_rect(color = "black")
   ) +
  facet_wrap(~fct_relevel(var, nms2$var), ncol = 6, scales = "free_x",
             labeller = label_wrap_gen(multi_line = TRUE)) +
  ggh4x::facetted_pos_scales(x = scales)
  #scale_x_continuous(
  #limits =  c(NA, case_when(max(xlim) >= 4 ~ 4,
  #                          TRUE ~ NA)),
  #breaks =  c(-2, 0, 2, 4))

ggsave(here("Plots","Bin_Plot_All.pdf"), height = 10, width = 10)
```


```{r}
scales <- list(
#1
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#2
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#3
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#4                   
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#5
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#6
  scale_x_continuous(breaks = c(-2,0,2),
                     limits = c(NA, NA)),
#7
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#8                   
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#9
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#10
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#11
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#12                   
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(-1, 5)),
#13
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#14
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA,NA)),
#15
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#16                   
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#17
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, 5)),
#18
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#19
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#20                   
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#21
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)),
#22
  scale_x_continuous(breaks = c(-2,0,2,4),
                     limits = c(NA, NA)))
```

