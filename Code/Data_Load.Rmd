---
title: "Data_Processing"
---

# Data Processing

This script pulls the `Master_Data` from the google drive folder, wrangles it to get everything in order, then saves the data s a csv.

This script INCLUDES the fossil data, and scales all the data, extant and extinct, together. This way the two spreadsheets can be easily used when needed. 

Also the `var_complete` and `var_missing` lists are created at the bottom

## Packages
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, googlesheets4, here, glue)

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)

here::i_am("README.md")
here()
```

## Load Extant data  

```{r message = FALSE, warning=FALSE}
#dat <- read_sheet("https://docs.google.com/spreadsheets/d/1-eknhyZ1JNnXqhg2kViyzVntC8NGZvILQX-aQQb1Jvk/edit#gid=325036460", na = c("NA", "?", "")) %>%
dat <- read_csv(here('Data', 'Raw_Extant_Data.csv'), na = c("NA", "?", "")) %>% 
  select(!NOTES) %>% 
# Recode Ordinal Rankings
  mutate(Loc_Ord = case_when(Loc_mode_Ordinal == "G"  ~ "G",
                             Loc_mode_Ordinal == "A"  ~ "A",
                             Loc_mode_Ordinal == "Sc" ~ "Sc",
                             Loc_mode_Ordinal == "T"  ~ "T",
                             Loc_mode_Ordinal == "Is" ~ "Is",
                             Loc_mode_Ordinal == "Sf" ~ "Sf",
                             Loc_mode_Ordinal == "Ss" ~ "Ss",
                             TRUE ~ NA),
         Loc_Ord = as.ordered(Loc_Ord),
         Loc_Ord = fct_relevel(Loc_Ord, c("G","A","Sc","T","Is","Sf","Ss")),
         # Combining the Intersurface and Semifossorial
         Loc_Ord2 = case_when(Loc_mode_Ordinal == "G" ~ "A",
                              Loc_mode_Ordinal == "A" ~ "A",
                              Loc_mode_Ordinal == "Sc" ~ "Sc",
                              Loc_mode_Ordinal == "T" ~ "T",
                              Loc_mode_Ordinal == "Is" ~ "B",
                              Loc_mode_Ordinal == "Sf" ~ "B",
                              Loc_mode_Ordinal == "Ss" ~ "B",
                             TRUE ~ NA),
         Loc_Ord2 = as.ordered(Loc_Ord2),
         Loc_Ord2 = fct_relevel(Loc_Ord2, c("B","T","Sc","A")),
         Loc_bin = case_when(Loc_mode_Binary == "Ground" ~ 0,
                             Loc_mode_Binary == "Tree" ~ 1,
                             TRUE ~ NA
                             ),
        # Loc_bin = as.factor(Loc_bin),
         Loc_mode_Categorical = as.factor(Loc_mode_Categorical),
         log_Mass = log(Mass_grams)) %>% 
    relocate(Loc_bin, .after = Loc_mode_Binary) %>% 
  relocate(Loc_Ord, .after = Loc_mode_Ordinal) %>% 
  relocate(Loc_Ord2, .after = Loc_Ord) %>%
  relocate(log_Mass, .before = Skl) %>% 
#################
#Calculate Indices!
#################
  mutate(SI = Sh / Sl,             # Scapular Index
         HRI = Hsw / Hl,           # Humeral Robustness Index
         HPI = Hpw / Hl,           # Humeral Proximal Index
         HEB = Hdw / Hl,           # Humeral Epicondyle Breadth
         HHRI = Hhl / Hl,          # Humeral Head Robustness Index
         HHW = Hhw / Hhl,          # Humeral Head Shape Index
         DI = Hdcw / Hsw,          # Deltopectoral Crest Index
         OLI = Uol / Ul,           # Olecranon Process Length Index
         BI = Rl / Hl,             # Brachial Index
         IM = (Hl+Ul)/(Fl+Tl),     # Intermembral Index
         PRTI = Mcl/(Hl+Rl),       # Palm Robustness Index
         MRI = Mcw / Mcl,          # Metacarpal Robustness
         MANUS = Ppl / Mcl,        # MANUS index
         MANUS2 = (Ppl+Ipl)/Mcl,   # MANUS index with intermed. phalanx
         MANUS3 = Ipl / Ppl,       # Ratio of int. phalanx to prox. phalanx - Luo's fave
         IRI = Fgh / Fl,           # Gluteal Index
         FRI = Fsw / Fl,           # Femoral Robustness
         FEB = Fdw / Fl,           # Femoral Epicondyle Breadth
         CI = Tl / Fl,             # Crural Index
         TRI = Tmw / Tl,           # Tibial Robustness Index
         #ANR = Anl / Al,          # Astragular Neck Robustness Index
         #CAR = Cal / Cl,          # Calcaneal Robustness Index
         IRI = Il / Pel,           # Illium Robustness Index
         PR = Il / Isl,            # Pelvic Index
         PES = Pppl / Mtl,         # PES INdex
         PES2 = (Pppl+Pipl)/Mtl,    # PES with intermediate Phalanx
         Toes = Pppl+Pipl          # Sum of PES toes, not a ratio
         ) %>% 
    # geometric mean
  drop_na(Tmw, Fdw, Tl, Fl, Fsw , Sl, Hdw, Hl, Hsw, Rl, Ul, Uol) %>%
  mutate(gm = ( Tmw * Fdw * Tl * Fl * Fsw * Sl * Hdw * Hl * Hsw * Rl * Ul * Uol)^(1/12),
         log_gm = log(gm)) %>%
  relocate(c(gm, log_gm), .before = log_Mass) %>% 
  # Log Shape Ratios
  mutate(lsSl = log(Sl/gm),
         lsHl = log(Hl/gm),
         lsHsw = log(Hsw/gm),
         lsHdw = log(Hdw/gm),
         lsUol = log(Uol/gm),
         lsUl = log(Ul/gm),
         lsRl = log(Rl/gm),
         lsFl = log(Fl/gm),
         lsFsw = log(Fsw/gm),
         lsFdw = log(Fdw/gm),
         lsTl = log(Tl/gm),
         lsTmw = log(Tl/gm),
         lsIpl = log(Ipl/gm),
         lsPppl = log(Pppl/gm),
         lsMtl = log(Mtl/gm),
         lsPpl = log(Ppl/gm),
         lsPipl = log(Pipl/gm),
         lsMcl = log(Mcl/gm),
         lsTpw = log(Tpw/gm),
         lsIsl = log(Isl/gm),
         lsIl = log(Il/gm),
         lsPel = log(Pel/gm),
         lsHpw = log(Hpw/gm),
         lsMcw = log(Mcw/gm),
         lsPpw = log(Ppw/gm),
         lsCl  = log(Cl /gm)) %>% 
  mutate_at(vars(Skl:Pdpw), log) %>% 
  mutate(Fos = FALSE) %>% 
  select(!c("Loc_mode_Binary", "Loc_mode_Ordinal", "Loc_mode_source")) 

spp_obs <- dat$Taxon_Upham_style %>% unique()

```

## Load Fossil Data  

```{r}
#fdat <- read_sheet("https://docs.google.com/spreadsheets/d/1k19eAQP7NY9kjht8HfhcJNJ-jtYK10qlsdLi4i38tVc/edit#gid=0", na = c("NA", "?", "", "NULL", "–")) %>% 
fdat <- read_csv(here('Data', 'Raw_Fossil_Data.csv'), na = c("NA", "?", "", "NULL", "–")) %>% 
  # Selecting only the lines with data
  # THIS NEEDS TO BE UPDATED AS MORE DATA COME IN!!
  slice (1:15) %>% 
  select(!NOTES) %>% 
  #############
  #LOCOMOTION COLUMNS
  ##################
  mutate(Loc_Ord = NA,
         Loc_Ord2 = NA,
         Loc_bin = NA,
         log_Mass = log(Mass_grams)) %>%
  relocate(Loc_bin, .after = Loc_mode_Binary) %>%
  relocate(Loc_Ord, .after = Loc_mode_Ordinal) %>% 
  relocate(Loc_Ord2, .after = Loc_Ord) %>%
  relocate(log_Mass, .before = Skl) %>% 
  mutate(gm = NA,
         log_gm = NA) %>%
  relocate(c(gm, log_gm), .before = log_Mass) %>%  
#################
#Calculate Indices!
#################
  mutate(SI = Sh / Sl,             # Scapular Index
         HRI = Hsw / Hl,           # Humeral Robustness Index
         HPI = Hpw / Hl,           # Humeral Proximal Index
         HEB = Hdw / Hl,           # Humeral Epicondyle Breadth
         HHRI = Hhl / Hl,          # Humeral Head Robustness Index
         HHW = Hhw / Hhl,          # Humeral Head Shape Index
         DI = Hdcw / Hsw,          # Deltopectoral Crest Index
         OLI = Uol / Ul,           # Olecranon Process Length Index
         BI = Rl / Hl,             # Brachial Index
         IM = (Hl+Ul)/(Fl+Tl),     # Intermembral Index
         PRTI = Mcl/(Hl+Rl),       # Palm Robustness Index
         MRI = Mcw / Mcl,          # Metacarpal Robustness
         MANUS = Ppl / Mcl,        # MANUS index
         MANUS2 = (Ppl+Ipl)/Mcl,   # MANUS index with intermed. phalanx
         MANUS3 = Ipl / Ppl,       # Ratio of int. phalanx to prox. phalanx - Luo's fave
         IRI = Fgh / Fl,           # Gluteal Index
         FRI = Fsw / Fl,           # Femoral Robustness
         FEB = Fdw / Fl,           # Femoral Epicondyle Breadth
         CI = Tl / Fl,             # Crural Index
         TRI = Tmw / Tl,           # Tibial Robustness Index
         #ANR = Anl / Al,          # Astragular Neck Robustness Index
         #CAR = Cal / Cl,          # Calcaneal Robustness Index
         IRI = Il / Pel,           # Illium Robustness Index
         PR = Il / Isl,            # Pelvic Index
         PES = Pppl / Mtl,         # PES INdex
         PES2 = (Pppl+Pipl)/Mtl,    # PES with intermediate Phalanx
         Toes = Pppl+Pipl          # Sum of PES toes, not a ratio
         ) %>% 
  # Log Shape Ratios
  mutate(lsSl = log(Sl/gm),
         lsHl = log(Hl/gm),
         lsHsw = log(Hsw/gm),
         lsHdw = log(Hdw/gm),
         lsUol = log(Uol/gm),
         lsUl = log(Ul/gm),
         lsRl = log(Rl/gm),
         lsFl = log(Fl/gm),
         lsFsw = log(Fsw/gm),
         lsFdw = log(Fdw/gm),
         lsTl = log(Tl/gm),
         lsTmw = log(Tl/gm),
         lsIpl = log(Ipl/gm),
         lsPppl = log(Pppl/gm),
         lsMtl = log(Mtl/gm),
         lsPpl = log(Ppl/gm),
         lsPipl = log(Pipl/gm),
         lsMcl = log(Mcl/gm),
         lsTpw = log(Tpw/gm),
         lsIsl = log(Isl/gm),
         lsIl = log(Il/gm),
         lsPel = log(Pel/gm),
         lsHpw = log(Hpw/gm),
         lsMcw = log(Mcw/gm),
         lsPpw = log(Ppw/gm),
         lsCl  = log(Cl /gm)) %>% 
  mutate_at(vars(Skl:Pdpw), log) %>% 
  mutate(Fos = TRUE) %>% 
  select(!c("Loc_mode_Binary", "Loc_mode_Ordinal", "Loc_mode_source"))
```


### Combine, scale, and split

```{r}
dat2 <- bind_rows(dat, fdat) %>% 
  mutate_at(vars(gm:lsCl), scale2)

dat2 %>% filter(Fos == FALSE) %>% select(!Fos) %>% write_csv(here("Data", "Extant_Master.csv"))

dat2 %>% filter(Fos == TRUE) %>% select(!Fos) %>% write_csv(here("Data", "Fossil_Master.csv"))
```

# Var Compete and Missing
Measurements with missing values or complete. 
Splitting up by measurement type as well.

```{r}
var_complete <- c("log_Mass", "Sl", "Hl", "Hsw", "Hdw", "Uol", "Ul", "Rl", "Fl", "Fsw", "Fdw", "Tl", "Tmw",  "HRI", "HEB", "OLI", "BI", "IM", "FRI", "FEB", "CI", "TRI", "lsSl", "lsHl", "lsHsw", "lsHdw", "lsUol", "lsUl", "lsRl", "lsFl", "lsFsw", "lsFdw", "lsTl", "lsTmw") %>% write_rds(here("Data", "var_complete.Rds"))

var_missing <- c("MANUS2", "MANUS3", "Ipl", "PES", "Pppl", "Mtl", "MANUS", "Ppl", "Mcl", "PRTI", "Tpw", "Isl", "Il", "Pel", "Hpw", "HPI", "Mcw", "MRI", "Ppw", "PES2", "Cl", "lsIpl", "lsPppl", "lsMtl", "lsPpl", "lsMcl", "lsTpw", "lsIsl", "lsIl", "lsPel", "lsHpw", "lsMcw", "lsPpw", "lsCl", "Pipl", "lsPipl") %>% write_rds(here("Data", "var_missing.Rds"))

var_complete_linear <- c("log_Mass", "Sl", "Hl", "Hsw", "Hdw", "Uol", "Ul", "Rl", "Fl", "Fsw", "Fdw", "Tl", "Tmw") %>% write_rds(here("Data", "var_complete_linear.Rds"))

var_missing_linear <- c( "Ipl",  "Pppl", "Mtl",  "Ppl", "Mcl",  "Tpw", "Isl", "Il", "Pel", "Hpw",  "Mcw",  "Ppw",  "Cl", "Pipl") %>% write_rds(here("Data", "var_missing_linear.Rds"))

var_complete_ratio <- c("HRI", "HEB", "OLI", "BI", "IM", "FRI", "FEB", "CI", "TRI", "lsSl", "lsHl", "lsHsw", "lsHdw", "lsUol", "lsUl", "lsRl", "lsFl", "lsFsw", "lsFdw", "lsTl", "lsTmw") #%>% write_rds(here("Data", "var_complete_ratio.Rds"))

var_missing_ratio <- c("MANUS2", "MANUS3",  "PES",  "MANUS", "PRTI",  "HPI",  "MRI", "PES2", "lsIpl", "lsPppl", "lsMtl", "lsPpl", "lsMcl", "lsTpw", "lsIsl", "lsIl", "lsPel", "lsHpw", "lsMcw", "lsPpw", "lsCl", "lsPipl") #%>% write_rds(here("Data", "var_missing_ratio.Rds"))


tt <- c(var_missing_ratio, var_complete_ratio) %>% write_rds(here("Data", "tt.Rds"))

rm(var_complete_ratio, var_missing_ratio)

rm(tt)
read_rds(here("Data", "tt.Rds"))
```

