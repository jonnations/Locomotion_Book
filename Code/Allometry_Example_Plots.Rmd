---
title: "Some examples of Allometry/Isometry/Nothing"
output:
  html_document:
    df_print: paged
---

When talking about allometry, we are looking at the correlation between body size and phenotypic measurement. 

```{r include=FALSE}
pacman::p_load(tidyverse, here, patchwork)

here::i_am("README.md")
here()

dat <- read_csv(here("Data", "Extant_Master.csv")) %>% mutate(Loc_bin =  as.factor(Loc_bin)) %>% drop_na(Loc_bin)
```

The models I would like to use include size as an interaction term. What this does is calculates the variation in the effect of phenotype on locomotion across the size spectrum. So if the relationship between phenotype and climbing is the same across all body masses, then there would be a zero (or near-zero) interaction effect.

If a measurement has a zero "size" effect size, and a zero size:measurement effect size, that means that size is playing no role in the effect of measurement on locomotion, and can completely be ignored. This is, I guess, no allometry and no isometry? Or size is fully "corrected for" in the measurement. PES2 is like this. 

```{r include=FALSE}

aloplot <- function(mass, var){
  dat %>% ggplot(aes(x = {{mass}}, y = {{var}})) + 
  geom_point(aes(color = Loc_bin)) +
  geom_smooth(method = lm, se = T, color = 'grey30') +
  stat_smooth(aes(color = Loc_bin),
              method = "lm",
              formula = y ~ x,
              geom = "smooth",
              se = FALSE) +
  coord_fixed() +
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  xlim(-2.5, 2.5) + ylim(-2.5, 2.5) + theme_bw()
}
```


## Some measurements with high size signal
```{r include = FALSE}
aloplot(log_gm, TRI) +
  ggtitle("+ size effect")  -> p1
aloplot(log_gm, MANUS) +
  ggtitle("+ size effect")  -> p2
aloplot(log_Mass, CI) +
  ggtitle("- size effect")  -> p3
aloplot(log_Mass, lsMcw) +
  ggtitle("+ size effect")  -> p4
aloplot(log_gm, lsSl) +
  ggtitle("- size effect")  -> p5
aloplot(log_gm, lsUol) +
  ggtitle("- size effect")  -> p6
aloplot(log_Mass, lsPpl) +
  ggtitle("+ size effect")  -> p7
```


```{r fig.width = 10, fig.height = 8, fig.align='center', warning=FALSE, message=FALSE, echo=FALSE}
(p1 + p2 + p3) / (p4 + p5 + p6) +
  plot_layout(guides = 'collect') + plot_annotation(title = "Measurements with high size effect")
```


## Size effect and allometry

```{r}
aloplot(log_Mass, Ppl)  -> p4.1
aloplot(log_Mass, Mcw)  -> p4.2
aloplot(log_gm, Sl)  -> p5.2
aloplot(log_gm, Mtl)  -> p6.2
```

```{r fig.width = 16, fig.height = 8, fig.align='center', warning=FALSE, message=FALSE, echo=FALSE}

(p7 | p4 | p5 | p6) / (p4.1 | p4.2 | p5.2 | p6.2) +
  plot_layout(guides = 'collect') + plot_annotation(title = "three LSRs and the raw measurements showing different patterns")
```

## Some measurements with high mass:phenotype interaction
```{r include = FALSE}
aloplot(log_Mass, OLI) +
  ggtitle("+ size:pheno interaction")  -> p1
aloplot(log_Mass, MANUS2) +
  ggtitle("+ size:pheno interaction")  -> p2
aloplot(log_Mass, HRI) +
  ggtitle("- size:pheno interaction")  -> p3
aloplot(log_Mass, lsUol) +
  ggtitle("+ size:pheno interaction")  -> p4
aloplot(log_gm, lsPpw) +
  ggtitle("- size:pheno interaction")  -> p5
aloplot(log_gm, lsMcw) +
  ggtitle("- size:pheno interaction")  -> p6
```


```{r fig.width = 10, fig.height = 8, fig.align='center', warning=FALSE, message=FALSE, echo=FALSE}
(p1 + p2 + p3) / (p4 + p5 + p6) +
  plot_layout(guides = 'collect') + plot_annotation(title = "Measurements with high interactions")
```


## LSR  

|Size Effect & Interaction Effect | Measurement & Size Metric
|:---------------------|:-------------|
neg & neg   | none
neg & pos   | lsPel & lm
neg & no    | lsMtl & gm
pos & neg   | lsRl  & gm
pos & pos   | none 
pos & none  | lsPpl & gm
none & neg  | lsMcw & gm
none & pos  | lsUol & gm
none & none   | lsTl  & gm


```{r include=FALSE}
aloplot(log_Mass, lsPel) +
  ggtitle("- mass effect\n+ interaction")  -> p2

aloplot(log_gm,lsMtl) +
  ggtitle("- mass effect\nno interaction")  -> p3

aloplot(log_gm, lsRl) +
  ggtitle("+ mass effect\n- interaction")  -> p4

# No P6

aloplot(log_gm,lsPpl) +
  ggtitle("+ mass effect\nno interaction") -> p6

aloplot(log_gm, lsMcw) +
  ggtitle("no mass effect\n- interaction") -> p7

aloplot(log_gm,  lsUol) +
  ggtitle("no mass effect\n+ interaction") -> p8

aloplot(log_gm,  lsTl) +
  ggtitle("no mass effect\nno interaction") -> p9
```

```{r fig.width = 10, fig.height = 12, fig.align='center', warning=FALSE, message=FALSE, echo=FALSE}
(plot_spacer() + p2 + p3) / (p4 + plot_spacer() + p6) / (p7 + p8 + p9)  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Log-Shape Ratios")
```

#### What this means  
Walking through this: Remember, we are interested in the effect of phenotype (yaxis) on climbing (colors). The red line is the non-climbing regression, the blue line is the climbing regression, the grey line (slope) is the overall regression, and the dashed line is isometry. First off, I don't see any sign that any allometry is preserved in these particular log-shape ratios. Maybe metacarpal width increases with increased mass?  

## Index

|Size Effect & Interaction Effect | Measurement & Size Metric
|:---------------------|:-------------|
neg & neg   | MRI & lm
neg & pos   | none
neg & no    | CI & lm
pos & neg   | TRI & gm
pos & pos   | OLI & gm 
pos & none  | MANUS & gm sorta
none & neg  | HRI & gm
none & pos  | MANUS2 & lm
none & none   | HEB  & gm

```{r include=FALSE}
aloplot(log_Mass, MRI) +
  ggtitle("- mass effect\n- interaction")  -> p1

# no p2

aloplot(log_Mass, CI) +
  ggtitle("- mass effect\nno interaction")  -> p3

aloplot(log_gm, TRI) +
  ggtitle("+ mass effect\n- interaction")  -> p4

aloplot(log_gm, OLI) +
  ggtitle("+ mass effect\n+ interaction")  -> p5

aloplot(log_gm, MANUS) +
  ggtitle("+ mass effect\nno interaction")  -> p6

aloplot(log_gm, HRI) +
  ggtitle("no mass effect\n- interaction")  -> p7

aloplot(log_Mass, MANUS2) +
  ggtitle("no mass effect\n+ interaction")  -> p8

aloplot(log_gm, HEB) +
  ggtitle("no mass effect\nno interaction")  -> p9
```


```{r fig.width = 10, fig.height = 12, fig.align='center', warning=FALSE, message=FALSE,echo=FALSE}
(p1 + plot_spacer() + p3) / (p4 + p5 + p6) / (p7 + p8 + p9)  +
  plot_layout(guides = 'collect') + plot_annotation(title = "Functional indices")
```

## Models 

```{r include=FALSE}
x1 = rnorm(100, -1, 2)
error=rnorm(100,1,1)
y1 = (x1 ) + error
tt <- tibble(x = x1, y = y1)


x2 = rnorm(100, 1, 2)
error=rnorm(100,-1,1)
y2 = (x2) + error
tt2 <- tibble(x = x2, y = y2)

tt <- tt %>% bind_rows(tt2) %>% mutate(type = as.factor(rep(c(1, 2), each = 100)))

tt %>% ggplot(aes(x = x, y = y, color = type)) + geom_point()
```

```{r include=FALSE}
broom::tidy(glm(data = tt, family = binomial, formula = type ~ x)) %>% mutate_at(2:5, round, 3)
broom::tidy(glm(data = tt, family = binomial, formula = type ~ x + y)) %>% mutate_at(2:5, round, 3)
broom::tidy(glm(data = tt, family = binomial, formula = type ~ x * y)) %>% mutate_at(2:5, round, 3)
```

```{r include=FALSE}
x1 = rnorm(100, 5, 2)
error=rnorm(100,1,1)
y1 = (x1 * (0.1* error)) + error
tt <- tibble(x = x1, y = y1)


x2 = rnorm(100, 6, 2)
error=rnorm(100,-1,1)
y2 = (x2) + error
tt2 <- tibble(x = x2, y = y2)

tt <- tt %>% bind_rows(tt2) %>% mutate(type = as.factor(rep(c(1, 2), each = 100)))

tt %>% ggplot(aes(x = x, y = y, color = type)) + geom_point()
```

```{r include=FALSE}
broom::tidy(glm(data = tt, family = binomial, formula = type ~ x)) %>% mutate_at(2:5, round, 3)
broom::tidy(glm(data = tt, family = binomial, formula = type ~ x + y)) %>% mutate_at(2:5, round, 3)
broom::tidy(glm(data = tt, family = binomial, formula = type ~ x * y)) %>% mutate_at(2:5, round, 3)
```