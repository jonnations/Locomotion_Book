---
title: "Predicting Binary Climbing"
output: html_notebook
---


# Predicting climbing from fossil data:

Take model lists, then use them one by one to predict climbing in the fossil taxa.
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, brms, cmdstanr, here, tidybayes, patchwork, glue, ggthemes)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))
nms <- read_rds(here("Data", "Order_Names.Rds"))

source(here("Code","Name_Change.R"))


```


### Load Data  

```{r}
dat <- read_csv(here("Data", "Extant_Master.csv"))

fdat <- read_csv(here("Data", "Fossil_Master.csv"))

fdat_cln <- fdat %>% janitor::remove_empty(which = "cols") %>% colnames()

#variables to do fossil predictions with
pred_vars <- fdat_cln[c(9:83)]

#species in dataset
spp_obs <- dat$Taxon_Upham_style %>% unique()

#Color palette
pal = c('#62361B', '#f48a1a', '#e6ab02', '#66a61e', '#31c1bb', '#0d57ff', '#5e1ea6', '#f9581c' , '#f384f8')
```

### Load & Subset Models

Loading our list of log(Mass) models and selecting the ones for which we have fossil measurements. 

```{r}
list_b_lm <- read_rds(here("Data","B_lm_mods_mis.Rds"))
#purrr keep_at is great!
list_b2 <- list_b_lm %>% keep_at(pred_vars)

names(list_b2)

rm(list_b_lm)
```
Now, loop through (or purrr) models and predict the climbing scores for each fossil for each model

# Predictions  

## Fossil Functions
```{r}
colz <- c("Genus_species", "log_Mass", names(list_b2), "Specimen_Num")

fd <- fdat %>% select(colz)

nnn <- function(mod, nm){
  {{mod}} %>% 
    add_epred_draws(newdata = fdat, 
                    resp = "Locbin",
                    value = "Prob_of_Climbing",
                    allow_new_levels = TRUE, 
                    re_formula = NA) %>% 
    as.data.frame() %>% 
    select(Genus_species, Prob_of_Climbing, Specimen_Num) %>% 
    mutate(var = {{nm}})
}

```

# Extant Functions

```{r}
model_dat <- dat %>% filter(Genus_species %in% c("Didelphis_virginiana", "Sciurus_carolinensis",  "Tupaia_glis", "Cynocephalus_volans", "Glis_glis", "Hemicentetes_semispinosus", "Atelerix_albiventris", "Sorex_trowbridgii", "Urocitellus_columbianus", "Monodelphis_domestica"))

nnn2 <- function(mod, nm){
  {{mod}} %>% 
    add_epred_draws(newdata = model_dat, 
                    resp = "Locbin",
                    value = "Prob_of_Climbing",
                    #allow_new_levels = TRUE, 
                    re_formula = NULL) %>% 
    as.data.frame() %>% 
    select(Genus_species, Prob_of_Climbing, Specimen_Num) %>% 
    mutate(var = {{nm}})
  
}

nnn3 <- function(mod, nm){
  {{mod}} %>% 
    add_epred_draws(newdata = model_dat, 
                    resp = "Locbin",
                    value = "Prob_of_Climbing",
                    #allow_new_levels = TRUE, 
                    re_formula = NA) %>% 
    as.data.frame() %>% 
    select(Genus_species, Prob_of_Climbing, Specimen_Num) %>% 
    mutate(var = {{nm}})
}


extant_climb <- c("Didelphis_virginiana", "Sciurus_carolinensis",  "Tupaia_glis", "Cynocephalus_volans", "Glis_glis")

extant_ground <- c("Hemicentetes_semispinosus", "Atelerix_albiventris", "Sorex_trowbridgii", "Urocitellus_columbianus", "Monodelphis_domestica")

extant <- c("Didelphis_virginiana", "Sciurus_carolinensis",  "Tupaia_glis", "Cynocephalus_volans", "Glis_glis", "Hemicentetes_semispinosus", "Atelerix_albiventris", "Sorex_trowbridgii", "Urocitellus_columbianus", "Monodelphis_domestica")


old <- c("Eomaia_scansoria", "Sinodelphys_szalayi", "Juramaia_sinensis", "Cokotherium_jiufotangensis", "Ambolestes_zhoui")

multi <- c("Rugosodon_eurasiaticus", "Jeholbaatar_kielanae", "Filikomys_primaevus", "Ptilodus_kummae", "Kryptobaatar_dashzevegi")

primate <- c("Plesiadapis_cookei", "Torrejonia_wilsoni", "Ignacius_clarkforkensis", "Dryomomys_szalayi")
```

### Plot helpers
```{r}
var_ord = c("HPI", "OLI", "FRI", "CI", "FEB", "Uol", "PRTI", "HEB", "HRI", "Mtl", "TRI", "Ppw", "Cl", "Mcw", "MRI", "Tmw", "BI", "Pel", "Fsw", "Fdw", "Mcl", "Hdw", "Tl", "Pppl", "Hsw", "IM", "Ul", "Fl", "Rl", "MANUS2", "Hl", "Ipl", "MANUS", "Ppl", "PES", "PES2") 
#just the "sigs"
var_ord2 = c("HPI", "OLI", "FRI", "CI", "FEB", "Uol", "PRTI", "HEB", "HRI", "Mtl", "TRI", "Ppw", "Cl", "Mcw", "MRI", "IM", "Ul", "Fl", "Rl", "MANUS2", "Hl", "Ipl", "MANUS", "Ppl", "PES", "PES2")
# just the really important sigs
var_ord3 = c("HPI", "OLI", "FRI", "CI", "FEB", "Uol", "PRTI", "HEB", "HRI", "Rl", "MANUS2", "Hl", "Ipl", "MANUS", "Ppl", "PES", "PES2")
#pal = c('#66a61e', '#5e1ea6',  '#e6ab02', '#f9581c','#0d57ff')
#with the mean probability
var_ord4 = c("HPI", "OLI", "FRI", "CI", "FEB", "Uol", "PRTI", "HEB", "HRI", "Rl", "MANUS2", "Hl", "Ipl", "MANUS", "Ppl", "PES", "PES2", "Mean")

```


```{r}
nm <- names(list_b2)

pred_df <- map2(list_b2, nm, ~nnn(.x, .y)) %>% bind_rows() %>% 
  write_csv(here("Data", "Fossil_Predictions.csv")) %>% 
  mutate(method = "Fossil",
         substrate = NA)


pred_df_ext_full <- map2(list_b2, nm, ~nnn2(.x, .y)) %>% 
  bind_rows() %>% 
  mutate(method = "Full",
         substrate = case_when(
    Genus_species %in% extant_climb ~ "Climb",
    TRUE ~ "Ground"
  ))

pred_df_ext_fos <- map2(list_b2, nm, ~nnn3(.x, .y)) %>% 
  bind_rows() %>% 
  mutate(method = "Fossil",
         substrate = case_when(
    Genus_species %in% extant_climb ~ "Climb",
    TRUE ~ "Ground"
  ))


pred_all <- bind_rows(pred_df_ext_full, pred_df_ext_fos, pred_df) %>% filter(var %in% var_ord3) %>% 
  mutate(draw = rep(1:4000, times = nrow(.)/4000)) %>% 
  #THIS IS AVERAGING PER SPECIES
  group_by(substrate, method, var, Genus_species, draw) %>% 
  summarize(Prob_of_Climbing = mean(Prob_of_Climbing, na.rm = TRUE)) %>% ungroup() %>% 
  write_csv(here("Data", "All_Predictions.csv"))
```
## Add means to the plots?
Isn't really a good idea because there is uneven sampling across measurements
```{r}
#meandf <- pred_all %>% group_by(substrate, method, Genus_species, draw) %>% 
#  summarize(Prob_of_Climbing = mean(Prob_of_Climbing, na.rm = TRUE)) %>% 
#  ungroup() %>% 
#  mutate(var = "Mean")
#
#pred_all <- bind_rows(pred_all, meandf)
```




# Whole Shebang  


### function
```{r}
hplot <- function(groups, method){
  pred_all %>% filter(Genus_species %in% {{groups}},
                         method == {{method}}) %>% 
    mutate(var =  as.factor(var)) %>% 
  ggplot(aes(y = Prob_of_Climbing, 
             x = fct_relevel(var,var_ord3), 
             #y = var,
             color = Genus_species)) +
  geom_hline(yintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = c(0.5, 0.68268), 
                     #linewidth = c(0.75, 0.5), 
                     position = position_dodge(width = -.6)) + ylim(0,1) +
    labs(x = "", y = "Probability of Climbing") +
  scale_color_manual(values = pal) + theme_pander() + 
  theme(axis.text.x=element_text(angle=45, hjust=1),
        panel.border = element_rect(colour = "grey40", fill=NA, size=0.7) )
}


```

###  big df



### Big Plot
```{r}
pl5 <- hplot(old, "Fossil") + 
  ggtitle("Mesozoic Mammal Predictions") + 
  theme(axis.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title.y = element_blank())

pl6 <- hplot(multi, "Fossil") + 
  ggtitle("Multituberculate Predicitons") + 
  theme(axis.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title.y = element_blank())

pl7 <- hplot(primate, "Fossil") + 
  ggtitle("Primate Predicitons") + 
  theme(#axis.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title.y = element_blank())


t3 <- pl5 / pl6 /pl7

t3

ggsave(here("Plots", "Predict_Fossil.pdf"), height = 9, width = 13)

```


```{r}
pl1 <- hplot(extant_climb, "Full") + 
  ggtitle("Extant Climb Full Predictions") + 
  theme(axis.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title.y = element_blank())

pl2 <- hplot(extant_climb, "Fossil") + 
  ggtitle("Extant Climb Fossil") + 
  theme(axis.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title.y = element_blank())

pl3 <- hplot(extant_ground, "Full") + 
  ggtitle("Extant Ground Full Predictions") + 
  theme(axis.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),
        axis.title.y = element_blank())

pl4 <- hplot(extant_ground, "Fossil") + 
  ggtitle("Extant Ground Fossil") + 
  theme(#axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "lines"),)


t1 <- pl1 / pl2 + plot_layout(guides = "collect")

t2 <- pl3 / pl4 + plot_layout(guides = "collect")

wrap_plots(t1, t2, ncol = 1)

ggsave(here("Plots", "Predict_Extant.pdf"), height = 11, width = 13)

```

```{r}
wrap_plots(t1, t2, t3, ncol = 1)

ggsave(here("Plots", "Predict_All.pdf"), height = 19, width = 13)
```


# Testing
## What is predict doing?

```{r warning = FALSE, message = F}
m1 <- brm(y ~ x + (1|gr(phylo, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = sdat, 
          refresh = 0, 
          cores = 2,
          chains = 2,
          seed = 127,
          prior = c(prior(normal(0, 0.2), class = Intercept),
                prior(normal(1.75, 0.25), class = b),
                prior(normal(0, 0.5), class = sd)))

plot(conditional_effects(m1), points = TRUE)
```

predict

```{r}
sdat2 <- sdat %>% filter(phylo %in% c('t15', 't18', 't19', 't13'))
lt <- list(A = A)

sp1 <- m1 %>% add_epred_draws(newdata = sdat2, 
                    value = "pred",
                    allow_new_levels = TRUE, 
                    re_formula = NULL) %>% 
    as.data.frame() %>% 
    select(phylo, pred) %>% ggplot(aes(x = pred, y = phylo)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .75, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0.5,1)

sp2 <- m1 %>% add_epred_draws(newdata = sdat2, 
                    value = "pred",
                    allow_new_levels = TRUE, 
                    re_formula = NA) %>% 
    as.data.frame() %>% 
    select(phylo, pred) %>% ggplot(aes(x = pred, y = phylo)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .75, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0.5,1)

sp3 <- m1 %>% add_epred_draws(newdata = sdat2, 
                    value = "pred",
                    allow_new_levels = TRUE, 
                    re_formula = NULL,
                    newdata2 = lt) %>% 
    as.data.frame() %>% 
    select(phylo, pred) %>% ggplot(aes(x = pred, y = phylo)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .75, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0.5,1)

sp4 <- m1 %>% add_epred_draws(newdata = sdat2, 
                    value = "pred",
                    allow_new_levels = TRUE, 
                    re_formula = NULL,
                    sample_new_levels = "old_levels") %>% 
    as.data.frame() %>% 
    select(phylo, pred) %>% ggplot(aes(x = pred, y = phylo)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .75, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0.5,1)

sp5 <- m1 %>% add_epred_draws(newdata = sdat2, 
                    value = "pred",
                    allow_new_levels = TRUE, 
                    re_formula = NULL,
                    sample_new_levels = "gaussian") %>% 
    as.data.frame() %>% 
    select(phylo, pred) %>% ggplot(aes(x = pred, y = phylo)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .75, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0.5,1)

sp6 <- m1 %>% add_epred_draws(newdata = sdat2, 
                    value = "pred",
                    allow_new_levels = TRUE, 
                    re_formula = NA,
                    sample_new_levels = "gaussian") %>% 
    as.data.frame() %>% 
    select(phylo, pred) %>% ggplot(aes(x = pred, y = phylo)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .75, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0.5,1)

sp1 / sp2 / sp3 /sp4/sp5/sp6
```


## NEw prediction formulas
```{r}
nnn2 <- function(mod, nm){
  {{mod}} %>% 
    add_epred_draws(newdata = fdat, 
                    value = "Prob_of_Climbing",
                    allow_new_levels = TRUE, 
                    sample_new_levels = "gaussian",
                    re_formula = ~ (1 | Genus_species)) %>% 
    as.data.frame() %>% 
    select(Genus_species, Prob_of_Climbing) %>% 
    mutate(var = {{nm}})
  
}
nnn3 <- function(mod, nm){
  {{mod}} %>% 
    add_epred_draws(newdata = fdat, 
                    value = "Prob_of_Climbing",
                    allow_new_levels = TRUE, 
                    sample_new_levels = "old_levels",
                    re_formula = ~ (1 | Genus_species)) %>% 
    as.data.frame() %>% 
    select(Genus_species, Prob_of_Climbing) %>% 
    mutate(var = {{nm}})
  
}
nnn4 <- function(mod, nm){
  {{mod}} %>% 
    add_epred_draws(newdata = fdat, 
                    value = "Prob_of_Climbing",
                    allow_new_levels = TRUE, 
                    re_formula = ~ (1 | Genus_species)) %>% 
    as.data.frame() %>% 
    select(Genus_species, Prob_of_Climbing) %>% 
    mutate(var = {{nm}})
  
}

```

Using only measurements with no missing data so I can play around with re_formula

```{r}
#default with phylo
p1 <-  map2(list_b2, nm, ~nnn(.x, .y)) %>% bind_rows() %>% 
  filter(var %in% c("Hl", "CI", "Uol", "IM")) %>% 
  mutate(var =  as.factor(var)) %>% 
  ggplot(aes(x = Prob_of_Climbing, 
             #y = fct_relevel(var,var_ord), 
             y = var,
             color = Genus_species)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .5, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0,1) +
  scale_color_manual(values = pal) + theme_pander() + 
  theme_pander()

# gaussian
p2 <-  map2(list_b2, nm, ~nnn2(.x, .y)) %>% bind_rows() %>% 
  filter(var %in% c("Hl", "CI", "Uol", "IM")) %>% 
  mutate(var =  as.factor(var)) %>% 
  ggplot(aes(x = Prob_of_Climbing, 
             #y = fct_relevel(var,var_ord), 
             y = var,
             color = Genus_species)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .5, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0,1) +
  scale_color_manual(values = pal) + theme_pander() + 
  theme_pander()
  
# old levels
p3 <- map2(list_b2, nm, ~nnn3(.x, .y)) %>% bind_rows() %>% 
  filter(var %in% c("Hl", "CI", "Uol", "IM")) %>% 
  mutate(var =  as.factor(var)) %>% 
  ggplot(aes(x = Prob_of_Climbing, 
             #y = fct_relevel(var,var_ord), 
             y = var,
             color = Genus_species)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .5, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0,1) +
  scale_color_manual(values = pal) + theme_pander() + 
  theme_pander()
  
# re_formula to ~(1|Genus_species)
p4 <- map2(list_b2, nm, ~nnn4(.x, .y)) %>% bind_rows() %>% 
  filter(var %in% c("Hl", "CI", "Uol", "IM")) %>% 
  mutate(var =  as.factor(var)) %>% 
  ggplot(aes(x = Prob_of_Climbing, 
             #y = fct_relevel(var,var_ord), 
             y = var,
             color = Genus_species)) +
  geom_vline(xintercept = 0.5, linetype = 2, linewidth = 0.5) +
  stat_pointinterval(.width = .5, linewidth = 0.75, position = position_dodge(width = -.7)) + xlim(0,1) +
  scale_color_manual(values = pal) + theme_pander() + 
  theme_pander()
```



```{r}
(p1 | p2) / (p3 | p4) + plot_layout(guides = "collect")
```


testing with one model
```{r warning = FALSE}
m_hl <- list_b2[[20]]

m_hl %>% add_epred_draws(newdata = fdat, allow_new_levels = TRUE, re_formula = NA) %>% ggplot(aes(x = .epred, y = Genus_species)) + stat_pointinterval(.width = .5) + xlim(0,1)

m_hl %>% add_epred_draws(newdata = fdat, allow_new_levels = TRUE,re_formula = NA) %>% ggplot(aes(x = .epred, y = Genus_species)) + stat_pointinterval(.width = .5) + xlim(0,1)

```

```{r}
posterior_epred(m_hl, newdata = fdat, allow_new_levels = TRUE, re_formula = NA, resp = "Locbin", prob = 0.7) %>% as.data.frame() %>% summarise(across(where(is.numeric), mean)) %>% 
  t() %>% as.data.frame() #%>% mutate(species = fdat$Genus_species)
```


```{r}
m_hl <- list_b2[[20]]


dat2 <- dat %>% slice(3,14)

m_hl %>% add_epred_draws(newdata = dat2,  re_formula = NA, resp = "Locbin") %>% ggplot(aes(x = .epred, y = Genus_species)) + stat_interval(.width = .7) + xlim(0,1)

m_hl %>% add_epred_draws(newdata = dat2,  re_formula = NA) %>% ggplot(aes(x = .epred, y = Genus_species)) + stat_interval(.width = .7) + xlim(0,1)

#posterior_epred(m_hl, newdata = dat2, allow_new_levels = TRUE, re_formula = NA, resp = "Locbin") %>% as.data.frame() %>% summarise(across(where(is.numeric), mean)) %>% t() %>% as.data.frame() #%>% mutate(species = fdat$Genus_species)
```






# Testing model stuff unimportant here
```{r}
p1 = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1), class = b),
                prior(normal(0, 1), class = sd))

mm <- brm(Loc_bin ~ Ppl + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = dat, refresh = 0, chains = 2, cores = 2,
          prior = p1)

mm2 <- brm(Loc_bin ~ Ppl + log_Mass +  (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = dat, refresh = 0, chains = 2, cores = 2,
          prior = p1)
```


```{r}
plot(conditional_effects(mm, effects = "Ppl"))
plot(conditional_effects(mm2, effects = "Ppl"))
```



```{r}
bin_mod <-  bf(Loc_bin ~ mi(Ppl)  +  log_Mass  +  (1|Genus_species)  +  (1|gr(Taxon_Upham_style,cov = A)))  +  bernoulli()

imp_mod <- bf(Ppl| mi() ~ log_Mass  +  Sl  +   
       Hl  +  Hsw  +  Hdw  +  Uol  +  Ul  +  Rl  +  
       Fl  +  Fsw  +  Fdw  +  Tl  +   mi(Tmw) +
       (1|gr(Taxon_Upham_style, cov = A)))  +  gaussian()

imp_mod2 <- bf(Tmw | mi() ~ log_Mass  +  Sl  +   
       Hl  +  Hsw  +  Hdw  +  Uol  +  Ul  +  Rl  +  
       Fl  +  Fsw  +  Fdw  +  Tl  + 
       (1|gr(Taxon_Upham_style, cov = A)))  +  gaussian()

m_form <- bin_mod  +  imp_mod  +  imp_mod2 + set_rescor(FALSE)

pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 1)",
      class == "sd" ~ "normal(0, 1)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

m_mi_test <- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 

```

```{r}
m_mi_test

list_b2$Ppl
```

```{r}
ts <- plot(conditional_effects(list_b2$Ppl,  resp = "Locbin"), plot = F)[2]
tt <- plot(conditional_effects(m_mi_test, resp = "Locbin"), plot = F)[2]
ts
tt
```



```{r}
tictoc::tic()
t = m_hl %>% add_epred_draws(newdata = fdat, allow_new_levels = TRUE,re_formula = NA) %>% as.data.frame() %>%  lazy_dt() %>% select(Genus_species, .epred)
tictoc::toc()

tictoc::tic()
t2 = m_hl %>% add_epred_draws(newdata = fdat, allow_new_levels = TRUE,re_formula = NA) %>% as.data.frame() %>% select(Genus_species, .epred)
tictoc::toc()
```


