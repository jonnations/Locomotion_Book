---
title: "Prediction Accuracy"
#output: html_notebook
---

Testing the prediction accuracy

When using the phylogeny in the predicitons, they are quite acurate. When NOT using the phylogeny, they are not as good for the extant species. Fossil species will always have to be predicted without the phylogeny. But how do we make a statement about what to trust in this scenario?

Here, I want to check the extant predictions using the full models and the models without the group-level effects. If a particular measurement, without phylo, is pretty accurate for the extant species, then we can have more confience in the prediction for the fossil taxa. 

I am going to use the accuracy measurements method from the Carnivoran paper.


```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse,  brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue, furrr)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))
```


### Load data  
All data loading and wrangling in `Code/Data_Load.Rmd`
```{r}
dat <- read_csv(here("Data", "Extant_Master.csv")) %>% filter(Genus_species != "Urocyon_cinereoargenteus") %>% 
  filter(Genus_species != "Leopardus_geoffroyi")

fdat <- read_csv(here("Data", "Fossil_Master.csv"))

fdat_cln <- fdat %>% janitor::remove_empty(which = "cols") %>% colnames()

#variables to do fossil predictions with
#pred_vars <- fdat_cln[c(9:84)]

pred_vars <- dat %>% select(Sl:lsCl) %>% colnames()
#species in dataset
spp_obs <- dat$Taxon_Upham_style %>% unique()

#Color palette
pal = c('#62361B', '#f48a1a', '#e6ab02', '#66a61e', '#31c1bb', '#0d57ff', '#5e1ea6', '#f9581c' , '#f384f8')
```

### Load & Subset Models

Loading our list of log(Mass) models and selecting the ones for which we have fossil measurements. 

```{r}
list_b_lm <- read_rds(here("Data","B_lm_mods_mis.Rds"))
# lm list, and add lm suffix to names
names(list_b_lm) <- paste0(names(list_b_lm), "_lm")

list_b_gm <- read_rds(here("Data","B_gm_mods_mis.Rds"))
names(list_b_gm) <- paste0(names(list_b_gm), "_gm")

list_b_ratio <- read_rds(here("Data","B_ratio_mods_mis.Rds"))

list_b <- c(list_b_lm, list_b_gm, list_b_ratio) #%>% keep_at(pred_vars)

names(list_b)

#rm(list_b_lm, list_b_gm, list_b_ratio)

```

Now, loop through (or purrr) models and predict the climbing scores for each fossil for each model


# Big accuracy function
Should work with missing and non-missing models

great, this works.

```{r}
#WITH PHYLO
bin_pred_phy <- function(model){
  set.seed(124)
  d <-  predict({{model}}, summary = T, probs = c(0.055, 0.945),  resp = 'Locbin')
  d2 <- as.data.frame(d) %>% 
    rename_all(.,
               function(x) case_when(x == 'Estimate.Locbin' | x == 'Estimate' ~ 'pred',
                                     TRUE ~ x)) %>% 
  select(pred) %>% 
  mutate(pred_round = round(pred, digits = 0),
         actual = {{model}}[[2]][[1]],
         dif = abs(pred_round - actual),
        species = {{model}}[[2]]$Genus_species
        ) 
  return(d2)
}


bin_pred_phy_fn <- function(df){
  map(df, ~bin_pred_phy(.x)) %>% bind_rows()
}


## NO PHYLO
bin_pred_nophy <- function(model){
  set.seed(124)
  d <-  predict({{model}}, summary = T, probs = c(0.055, 0.945),  re_formula = NA, resp = 'Locbin')
  d2 <- as.data.frame(d) %>% 
    rename_all(.,
               function(x) case_when(x == 'Estimate.Locbin' | x == 'Estimate' ~ 'pred',
                                     TRUE ~ x)) %>% 
  select(pred) %>% 
  mutate(pred_round = round(pred, digits = 0),
         actual = {{model}}[[2]][[1]],
         dif = abs(pred_round - actual),
        species = {{model}}[[2]]$Genus_species)
}


bin_pred_nophy_fn <- function(df){
  map(df, ~bin_pred_nophy(.x)) %>% bind_rows()
}

```

```{r}
dfi <- as.data.frame(names(list_b)) 
colnames(dfi) <- "var"
```

```{r}
seed = 1298
pred1 <- map(1, ~bin_pred_phy_fn(list_b)) %>% 
  bind_rows() %>% 
  mutate(var = rep(dfi$var, each = 427),
         method = 'phy_int',
         mass = 'log_mass')

pred2 <- map(1, ~bin_pred_nophy_fn(list_b)) %>% 
  bind_rows() %>% 
  mutate(var = rep(dfi$var, each = 427),
         method = 'no_phy_int',
         mass = 'log_mass')


preds <- bind_rows(pred1, pred2)
```


## Calculate accuracy

Best, in order
```{r}
accuracy <- preds %>% 
  group_by(method, var, mass) %>%  
  summarise(accuracy = round((sum(dif == 0)/427) * 100, 
                             digits = 1)) %>% 
  select(var, accuracy, method, mass) %>% 
  arrange(desc(accuracy)) 

accuracy %>%
  filter(method == "no_phy_int") %>%
  kbl() %>%
  kable_classic_2(full_width = F)

accs <- accuracy %>%
  filter(method == "no_phy_int")
as.vector(accs$var) %>% write_rds(here("Data", "Accuracy_list.rds"))

accuracy %>% write_csv(here("Data", "Accuracy.csv"))
```
