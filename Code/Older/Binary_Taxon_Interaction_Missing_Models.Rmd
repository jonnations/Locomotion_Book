---
title: "Binary Taxon Interaction Classification"
output: html_notebook
---

Copy of `Binary_Missing_Models.Rmd` but with the interaction term AND the taxonomic groupings! This should help the predictions.

Using order and family

Predicting binary climbing classifications (tree vs. ground) using postcranial measurements and interactions. Models will also incorporate intraspecific variation and phylogenetic variation.

# Preparation  

### Load packages and functions  
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse,  brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))

source(here("Code","Name_Change.R"))
```

### Load data  
All data loading and wrangling in `Code/Data_Load.Rmd`
```{r}
dat <- read_csv(here("Data", "Extant_Master.csv")) %>% 
  filter( Genus_species !=  c('Leopardus_geoffroyi', 'Urocyon_cinereoargenteus')) %>% 
  mutate(Family = 
           case_when(Family == 'Callitrichidae (Cebidae)' ~ 'Callitrichidae',
                     Family == 'Prionodontidae (Viverridae)' ~ 'Prionodontidae',
                     TRUE ~ Family))

#species in dataset
spp_obs <- dat$Taxon_Upham_style %>% unique()

#Color palette
pal = c('#62361B', '#f48a1a', '#e6ab02', '#66a61e', '#31c1bb', '#0d57ff', '#5e1ea6', '#f9581c' , '#f384f8')
```

### Load Tree & Get Cor Matrix

```{r}
tr <- ape::read.nexus(
  here("Data","MCC_Upham_all_mammals.nex"))
tr <- ape::keep.tip(tr, spp_obs)
A <- ape::vcv.phylo(tr, corr = TRUE)
```

## Description of Missing Data
Follows `Binary_Missing_Models.Rmd`

```{r}
#var_complete <- write_rds(here("Data", "var_complete.Rds"))
#var_missing <- write_rds(here("Data", "var_missing.Rds"))
```


The percentages are stored in the df `Missing_Data_Percents.csv`

# Fit Models

## Log(Mass) Complete  

#### Prior  
```{r message = FALSE, warning=FALSE, include = FALSE}


p1 = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 2), class = b),
                prior(normal(0, 0.5), class = sd))
```

#### Prelim model  

```{r message = FALSE, warning=FALSE, include = FALSE, cache=TRUE}
#initial fit
mm <- brm(Loc_bin ~ Sl * log_Mass + (1|Family) + (1|Order) +  (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = dat, refresh = 0, cores = 4,
          prior = p1)
```

#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

list_b_lm <- vector(mode ="list")

for(i in var_complete){
  list_b_lm[[i]]<- update(mm,
                         formula=(paste0("Loc_bin ~", i, "*log_Mass+(1|Family)+(1|Order)+(1|gr(Taxon_Upham_style,cov = A))")),
                         family = bernoulli(),
                         newdata=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = p1,
                         seed = 145,
                         control = list(adapt_delta = 0.98)
                         ) 
}

```


## Missing log(Mass)

Update cannot be used with multivatiate models

Prior must be called in the loop


#### Run Loop

```{r message = FALSE, warning=FALSE, results = 'hide'}

for(i in var_missing){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|Family)+(1|Order)+(1|gr(Taxon_Upham_style,cov = A))")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145,
                         control = list(adapt_delta = 0.98)
                         ) 
}

list_b_lm %>% write_rds(here("Data","B_lm_Ord_Fam_int_mods_mis.Rds"))

```



# Fit Models

## Geometric Mean Complete  

#### Prior 
same prior as above
```{r message = FALSE, warning=FALSE, include = FALSE}

p1 = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 2), class = b),
                prior(normal(0, 0.5), class = sd))
```

#### Prelim model  

```{r message = FALSE, warning=FALSE, include = FALSE, cache=TRUE}
#initial fit
mm <- brm(Loc_bin ~ Sl * gm + (1|Family) + (1|Order) + (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = bernoulli(),
          data = dat, refresh = 0, cores = 4,
          prior = p1)
```

#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

list_b_gm <- vector(mode ="list")

for(i in var_complete){
  list_b_gm[[i]]<- update(mm,
                         formula=(paste0("Loc_bin ~", i, "*gm+(1|Family)+(1|Order)+(1|gr(Taxon_Upham_style,cov = A))")),
                         family = bernoulli(),
                         newdata=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = p1,
                         seed = 145,
                         control = list(adapt_delta = 0.98)
                         ) 
}

```


## Missing GM

Update cannot be used with multivariate models

Prior must be called in the loop



#### Run Loop
```{r  message = FALSE, warning=FALSE, results = 'hide', cache = TRUE}

for(i in var_missing){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*gm+(1|Family)+(1|Order)+(1|gr(Taxon_Upham_style,cov = A))")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ gm + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_gm[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 2,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145,
                         control = list(adapt_delta = 0.98)
                         ) 
}

list_b_gm %>% write_rds(here("Data","B_gm_Ord_Fam_int_mods_mis.Rds"))
```




