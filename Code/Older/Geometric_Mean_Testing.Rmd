---
title: "Geometric Means Trial"
output:
  html_document:
    df_print: paged
---

## How does the number of measurements used in calculating the geometric mean affect the effect sizes in a regression model?

```{r message = FALSE, warning=FALSE, include = FALSE}
pacman::p_load(tidyverse, googlesheets4, brms, cmdstanr, kableExtra, tidybayes, patchwork)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)
```


```{r message = FALSE, warning=FALSE, include = FALSE}
dat <- read_sheet("https://docs.google.com/spreadsheets/d/1-eknhyZ1JNnXqhg2kViyzVntC8NGZvILQX-aQQb1Jvk/edit#gid=325036460", na = c("NA", "?", "")) %>%
  select(!NOTES) %>% 
# Recode Ordinal Rankings
  mutate(Loc_Ord = case_when(Loc_mode_Ordinal == "G" ~ 1,
                             Loc_mode_Ordinal == "A" ~ 2,
                             Loc_mode_Ordinal == "Sc" ~ 3,
                             Loc_mode_Ordinal == "T" ~ 4,
                             Loc_mode_Ordinal == "Is" ~ 5,
                             Loc_mode_Ordinal == "Sf" ~ 5,
                             Loc_mode_Ordinal == "Ss" ~ 6,
                             TRUE ~ NA),
         Loc_Ord = as.ordered(Loc_Ord),
         Loc_bin = case_when(Loc_mode_Bindary == "Ground" ~ 0,
                             Loc_mode_Bindary == "Tree" ~ 1,
                             TRUE ~ NA
                             ),
        # Loc_bin = as.factor(Loc_bin),
         Loc_mode_Categorical = as.factor(Loc_mode_Categorical),
         log_Mass = log(Mass_grams)) %>% 
    relocate(Loc_bin, .after = Loc_mode_Bindary) %>% 
  relocate(Loc_Ord, .after = Loc_mode_Ordinal) %>% 
  relocate(log_Mass, .before = Skl) %>%
  
#################
#Calculate G means
#################
  drop_na(Hl , Ul , Tl , Fl , Hsw , Fsw , Fdw , Fsw , Sl , Sh , Hdw, Mcl, Ppl, log_Mass) %>% 
  mutate(gm1 = (Hl * Fl)^(1/2),
         gm2 = (Hl * Hsw * Fl * Fsw)^(1/4),
         gm3 = (Hl * Ul * Tl * Fl)^(1/4),
         gm4 = (Hl * Ul * Tl * Fl * Hsw * Fsw * Tmw)^(1/7),
         gm5 = (Hl * Ul * Tl * Fl * Hsw * Fsw * Fdw * Fsw * Sl * Sh * Hdw )^(1/11),
         gm6 = (Hl * Ul * Tl * Fl * Hsw * Fsw * Fdw * Fsw * Sl * Sh * Hdw * Mcl * Ppl)^(1/13),
         lg_sh_h = Hl / gm6,
         lg_sh_h2 = Hl / Mass_grams
         ) %>% 
  mutate_at(vars(17:71, 78:79), log) %>% 
  mutate_at(vars(16:79), scale2)
```

Here are the different Geometric Mean metrics, ranging from 2 length measurements to 6 length and 5 width. 

- gm1 = Hl, Fl  
- gm2 = Hl , Hsw , Fl , Fsw  
- gm3 = Hl , Ul , Tl , Fl  
- gm4 = Hl , Ul , Tl , Fl , Hsw , Fsw , Tmw
- gm5 = Hl , Ul , Tl , Fl , Hsw , Fsw , Fdw , Fsw , Sl , Sh , Hdw
- gm6 = Hl , Ul , Tl , Fl , Hsw , Fsw , Fdw , Fsw , Sl , Sh , Hdwm, Mcl, Ppl

To determine how estimates change, we will want to run the same model but alternate the gm measurement. log(Humerus length) seems to be a pretty good correlate of climbing, when conditioned on body size, so lets go with that one. 


I'm going to ignore intraspecific variation & phylogenetic variation for now.

Here are the models
```{r message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
# Geometric Mean models
mgm1 <- brm(Loc_bin ~ Hl + gm1,
           family = bernoulli(),
           data = dat, refresh = 0, seed = 131)
mgm2 <- update(mgm1, Loc_bin ~ Hl + gm2, newdata = dat, refresh = 0, seed = 131)
mgm3 <- update(mgm1, Loc_bin ~ Hl + gm3, newdata = dat, refresh = 0, seed = 131)
mgm4 <- update(mgm1, Loc_bin ~ Hl + gm4, newdata = dat, refresh = 0, seed = 131)
mgm5 <- update(mgm1, Loc_bin ~ Hl + gm5, newdata = dat, refresh = 0, seed = 131)
mgm6 <- update(mgm1, Loc_bin ~ Hl + gm6, newdata = dat, refresh = 0, seed = 131)
# log mass model
lm <- update(mgm1, Loc_bin ~ Hl + log_Mass, newdata = dat, refresh = 0, seed = 131)
# no mass model for comparison
nom <- update(mgm1, Loc_bin ~ Hl , newdata = dat, refresh = 0, seed = 131)

lsm <- update(mgm1, Loc_bin ~ lg_sh_h , newdata = dat, refresh = 0, seed = 131)
lsm2 <- update(mgm1, Loc_bin ~ lg_sh_h2 , newdata = dat, refresh = 0, seed = 131)
```



```{r message=FALSE, warning=FALSE, cache=TRUE, echo=FALSE}
d1 <- bind_rows(
  as_draws_df(nom) %>% select(b_Hl),
  as_draws_df(mgm1) %>% select(b_Hl),
  as_draws_df(mgm2) %>% select(b_Hl),
  as_draws_df(mgm3) %>% select(b_Hl),
  as_draws_df(mgm4) %>% select(b_Hl),
  as_draws_df(mgm5) %>% select(b_Hl),
  as_draws_df(mgm6) %>% select(b_Hl),
  as_draws_df(lm) %>% select(b_Hl),
  as_draws_df(lsm) %>% select(b_lg_sh_h) %>% rename(b_Hl = b_lg_sh_h)) %>% 
  mutate(mod = rep(c("no mass", "gm1", "gm2", "gm3", "gm4", "gm5", "gm6","lm", "log-shape"), each = 4000),
         p_Hl = inv_logit_scaled(b_Hl)) 

d2 <- bind_rows(
  as_draws_df(mgm1) %>% select(b_gm1) %>% rename(b_gm = b_gm1),
  as_draws_df(mgm2) %>% select(b_gm2) %>% rename(b_gm = b_gm2),
  as_draws_df(mgm3) %>% select(b_gm3) %>% rename(b_gm = b_gm3),
  as_draws_df(mgm4) %>% select(b_gm4) %>% rename(b_gm = b_gm4),
  as_draws_df(mgm5) %>% select(b_gm5) %>% rename(b_gm = b_gm5),
  as_draws_df(lm) %>% select(b_log_Mass) %>% rename(b_gm = b_log_Mass)
  ) %>% 
  mutate(p_gm = inv_logit_scaled(b_gm)) #%>% 
  #bind_cols(d1)

d1 %>% 
  ggplot(aes(x = p_Hl, y = mod)) + 
  stat_halfeye() + 
  labs(title = "The effect of Humerus length on climbing among 5\ndifferent geometric mean measures and log(mass)",
       subtitle = "The effect size is much larger using log(mass) than any of the geometric means!\nYou can use the no-mass model for comparison .") +
  theme_bw()
```

The results are strongly supported with model comparison
```{r cache=TRUE}
loo(mgm1, mgm2,mgm3, mgm4, mgm5, mgm6, lm)[[2]]
```


```{r echo=FALSE, fig.asp=1, fig.width=9, message=FALSE, warning=FALSE, cache=TRUE}
p1 <- plot(conditional_effects(nom), points = T, plot = F)[[1]] + 
  labs(subtitle = "No Mass Included in Model") + theme_bw()
p2 <- plot(conditional_effects(mgm1), points = T, plot = F)[[1]] + 
  labs(subtitle = "Geom. Mean 1 (2 length variables)") + theme_bw()
p3 <- plot(conditional_effects(mgm6), points = T, plot = F)[[1]] + 
  labs(subtitle = "Geom. Mean 6 (8 length & 5 width variables)") + theme_bw()
p4 <- plot(conditional_effects(lm), points = T, plot = F)[[1]] + 
  labs(subtitle = "log (Mass)") + theme_bw()
p5 <- plot(conditional_effects(lsm), points = T, plot = F)[[1]] + 
  labs(subtitle = "log shape ratio -> log(Hl/gm6)") + theme_bw()
p6 <- plot(conditional_effects(lsm2), points = T, plot = F)[[1]] + 
  labs(subtitle = "log shape ratio -> log(Hl/Mass)") + theme_bw()

(p1 | p2) / (p3 | p4)  / (p5 | p6) + plot_annotation(
  title = 'Humerus Length conditioned on 3 different measures of Size',
  subtitle = 'This plot really reinforces the previous one. log(Mass) removes far more of the effect of body size\nfrom the model than any geometric mean measurement does')

```


Log 

Lets fit a couple of models with other variables for fun


```{r message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
# Geometric Mean models
mgm1.2 <- update(mgm1, Loc_bin ~ Ppl + gm1, newdata = dat, refresh = 0, seed = 131)
mgm2.2 <- update(mgm1, Loc_bin ~ Ppl + gm2, newdata = dat, refresh = 0, seed = 131)
mgm3.2 <- update(mgm1, Loc_bin ~ Ppl + gm3, newdata = dat, refresh = 0, seed = 131)
mgm4.2 <- update(mgm1, Loc_bin ~ Ppl + gm4, newdata = dat, refresh = 0, seed = 131)
mgm5.2 <- update(mgm1, Loc_bin ~ Ppl + gm5, newdata = dat, refresh = 0, seed = 131)
mgm6.2 <- update(mgm1, Loc_bin ~ Ppl + gm6, newdata = dat, refresh = 0, seed = 131)
# log mass model
lm.2 <- update(mgm1, Loc_bin ~ Ppl + log_Mass, newdata = dat, refresh = 0, seed = 131)
# no mass model for comparison
nom.2 <- update(mgm1, Loc_bin ~ Ppl , newdata = dat, refresh = 0, seed = 131)
```


```{r echo=FALSE, fig.asp=1, fig.width=8, message=FALSE, warning=FALSE, cache=TRUE}
p1 <- plot(conditional_effects(nom.2), points = T, plot = F)[[1]] + 
  labs(subtitle = "No Mass Included in Model") + theme_bw()
p2 <- plot(conditional_effects(mgm1.2), points = T, plot = F)[[1]] + 
  labs(subtitle = "Geom. Mean 1 (2 length variables)") + theme_bw()
p3 <- plot(conditional_effects(mgm6.2), points = T, plot = F)[[1]] + 
  labs(subtitle = "Geom. Mean 6 (8 length & 5 width variables)") + theme_bw()
p4 <- plot(conditional_effects(lm.2), points = T, plot = F)[[1]] + 
  labs(subtitle = "log (Mass)") + theme_bw()

(p1 | p2) / (p3 | p4)  + plot_annotation(
  title = 'Prox Phalanx Length conditioned on 3 different measures of Size')

```

And Prox Plalanx Length does a better job predicting locomotion than humerus across the board!
```{r cache=TRUE, message=FALSE, warning=FALSE}
loo( mgm4, mgm4.2, mgm6, mgm6.2, lm, lm.2)[[2]]
```
