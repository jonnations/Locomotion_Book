---
title: "Ordinal Classification"
output: html_notebook
---

Predicting Ordinal Locomotion classifications (6 rankings) using postcranial measurements. Models will also incorporate intraspecific variation and phylogenetic variation.

## Preperation  

### Load packages and functions  
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse, googlesheets4, brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()
```

### Load data  
### Load data  
```{r message = FALSE, warning=FALSE}
dat <- read_sheet("https://docs.google.com/spreadsheets/d/1-eknhyZ1JNnXqhg2kViyzVntC8NGZvILQX-aQQb1Jvk/edit#gid=325036460", na = c("NA", "?", "")) %>%
  select(!NOTES) %>% 
# Recode Ordinal Rankings
  mutate(Loc_Ord = case_when(Loc_mode_Ordinal == "G"  ~ "G",
                             Loc_mode_Ordinal == "A"  ~ "A",
                             Loc_mode_Ordinal == "Sc" ~ "Sc",
                             Loc_mode_Ordinal == "T"  ~ "T",
                             Loc_mode_Ordinal == "Is" ~ "Is",
                             Loc_mode_Ordinal == "Sf" ~ "Sf",
                             Loc_mode_Ordinal == "Ss" ~ "Ss",
                             TRUE ~ NA),
         Loc_Ord = as.ordered(Loc_Ord),
         Loc_Ord = fct_relevel(Loc_Ord, c("G","A","Sc","T","Is","Sf","Ss")),
         # Combining the Intersurface and Semifossorial
         Loc_Ord2 = case_when(Loc_mode_Ordinal == "G" ~ "G",
                              Loc_mode_Ordinal == "A" ~ "A",
                              Loc_mode_Ordinal == "Sc" ~ "Sc",
                              Loc_mode_Ordinal == "T" ~ "T",
                              Loc_mode_Ordinal == "Is" ~ "Sf",
                              Loc_mode_Ordinal == "Sf" ~ "Sf",
                              Loc_mode_Ordinal == "Ss" ~ "Ss",
                             TRUE ~ NA),
         Loc_Ord2 = as.ordered(Loc_Ord2),
         Loc_Ord2 = fct_relevel(Loc_Ord2, c("G","A","Sc","T","Sf","Ss")),
         Loc_bin = case_when(Loc_mode_Bindary == "Ground" ~ 0,
                             Loc_mode_Bindary == "Tree" ~ 1,
                             TRUE ~ NA
                             ),
        # Loc_bin = as.factor(Loc_bin),
         Loc_mode_Categorical = as.factor(Loc_mode_Categorical),
         log_Mass = log(Mass_grams)) %>% 
    relocate(Loc_bin, .after = Loc_mode_Bindary) %>% 
  relocate(Loc_Ord, .after = Loc_mode_Ordinal) %>% 
  relocate(Loc_Ord2, .after = Loc_Ord) %>%
  relocate(log_Mass, .before = Skl) %>% 
#################
#Calculate Indices!
#################
  mutate(SI = Sh / Sl,             # Scapular Index
         HRI = Hsw / Hl,           # Humeral Robustness Index
         HPI = Hpw / Hl,           # Humeral Proximal Index
         HEB = Hdw / Hl,           # Humeral Epicondyle Breadth
         HHRI = Hhl / Hl,          # Humeral Head Robustness Index
         HHW = Hhw / Hhl,          # Humeral Head Shape Index
         DI = Hdcw / Hsw,          # Deltopectoral Crest Index
         OLI = Uol / Ul,           # Olecranon Process Length Index
         BI = Rl / Hl,             # Brachial Index
         IM = (Hl+Ul)/(Fl+Tl),     # Intermembral Index
         PRTI = Mcl/(Hl+Rl),       # Palm Robustness Index
         MRI = Mcw / Mcl,          # Metacarpal Robustness
         MANUS = Ppl / Mcl,        # MANUS index
         MANUS2 = (Ppl+Ipl)/Mcl,   # MANUS index with intermed. phalanx
         IRI = Fgh / Fl,           # Gluteal Index
         FRI = Fsw / Fl,           # Femoral Robustness
         FEB = Fdw / Fl,           # Femoral Epicondyle Breadth
         CI = Tl / Fl,             # Crural Index
         TRI = Tmw / Tl,           # Tibial Robustness Index
         #ANR = Anl / Al,          # Astragular Neck Robustness Index
         #CAR = Cal / Cl,          # Calcaneal Robustness Index
         IRI = Il / Pel,           # Illium Robustness Index
         PR = Il / Isl,            # Pelvic Index
         PES = Pppl / Mtl,         # PES INdex
         PES2 = (Pppl+Pipl)/Mtl    # PES with intermediate Phalanx
         ) %>% 
    # geometric mean
  drop_na(Tmw, Fdw, Tl, Fl, Fsw , Sh, Sl, Hdw, Hl, Hsw, Rl, Ul, Uol) %>%
  mutate(gm = ( Tmw * Fdw * Tl * Fl * Fsw  * Sh * Sl * Hdw * Hl * Hsw * Rl * Ul * Uol)^(1/13)) %>%
  relocate(gm, .before = log_Mass) %>% 
  mutate_at(vars(19:73), log) %>% 
  mutate_at(vars(17:95), scale2)

spp_obs <- dat$Taxon_Upham_style %>% unique()
```

### Load Tree & Get Cor Matrix

```{r}
tr <- ape::read.nexus(
  here("Data","MCC_Upham_all_mammals.nex"))
tr <- keep.tip(tr, spp_obs)
A <- ape::vcv.phylo(tr, corr = TRUE)
```

### Fit Models 


Looping over all of the variables to see which ones do a good job predicting the binary tree vs. no-tree categorization

#### Get Prior

```{r message = FALSE, warning=FALSE, include = FALSE}

p1 <- get_prior(Loc_Ord2 ~ Sl + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
  data2 = list(A = A),
           family = cumulative(),
           data = dat) %>% 
    mutate(
      prior = case_when(
        class == "b"  ~ "normal(0, 1)",
        class == "sd" ~ "normal(0, 1)",
        class == "Intercept" ~ "normal(0, 1)",
        TRUE ~ prior
      )
    )
```


```{r message = FALSE, warning=FALSE, include = FALSE, cache=TRUE}
#initial fit
mm <- brm(Loc_Ord2 ~ Sl + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)),
          data2 = list(A = A),
          family = cumulative(),
          data = dat, refresh = 0, cores = 4,
          prior = p1)
```



```{r}

cols = c("#7570b3" ,  "#85D4E3" , "#0D7E9A",'#f5f5cb', '#c7e6d4', '#8cd2cd', '#55c3cf', '#3fa4b0', '#187389','#f48a1a', '#e6ab02', '#66a61e', '#85D4E3', '#0D7E9A', '#7570b3','#f6d03d', '#fe7b30', '#ef4a27', '#f384f8', '#625afc', '#0d57ff', '#47a7ff','#5771ff', '#6bae9e', '#31c1bb', '#7af1e1', '#d5e1af', '#f48130','#C60C30', '#00A1DE', '#62361B', '#009B3A', '#f9581c', '#522398', '#E27EA6', '#F9E300', '#565A5C')
```

```{r}
pal = c('#62361B', '#f48a1a', '#e6ab02', '#66a61e', '#31c1bb', '#0d57ff', '#7570b3')
plot(conditional_effects(mm, categorical = TRUE), plot = F)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)
```

#### Log Mass Loop

```{r  message = FALSE, warning=FALSE, include = FALSE,}
varis <- colnames(dat)[19:95]

list_o_lm <- vector(mode ="list")

for(i in varis){
  list_o_lm[[i]]<- update(mm,
                         formula=(paste0("Loc_Ord ~", i, "+log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A))")),
                         family = cumulative(),
                         newdata=dat,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = p1
                         ) 
}

list_o_lm %>% write_rds(here("Data","ordinal_lm_models.Rds"))
```


#### Geometric Mean Loop

```{r  message = FALSE, warning=FALSE, include = FALSE}
varis <- colnames(dat)[19:95]

list_o_gm <- vector(mode ="list")

for(i in varis){
  list_o_gm[[i]]<- update(mm,
                         formula=(paste0("Loc_Ord ~", i, "+gm+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A))")),
                         family = cumulative(),
                         newdata=dat,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = p1
                         ) 
}

list_o_gm %>% write_rds(here("Data","ordinal_gm_models.Rds"))
```


### Plots 

#### Just for kicks, probably good to skip this.

```{r}
list_o_lm <- read_rds(here("Data","ordinal_lm_models.Rds"))
list_o_gm <- read_rds(here("Data","ordinal_gm_models.Rds"))
```

```{r message = FALSE, warning=FALSE}
#for(i in list_o_lm){
# plots <- plot(conditional_effects(i, categorical = TRUE), plot=F, points = T)[[1]] +
#  scale_fill_manual(values = pal) +
#  scale_color_manual(values = pal) + ylim(0,1)
# print(plots + theme_bw())
#}

#for(i in list_o_gm){
# plots <- plot(conditional_effects(i, categorical = TRUE), plot=F, points = T)[[1]] +
#  scale_fill_manual(values = pal) +
#  scale_color_manual(values = pal) + ylim(0,1)
# print(plots + theme_bw()) 
#}

```

### Four plots for comparisons 

```{r}
p1 <- plot(conditional_effects(list_o_lm$OLI, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)+ ylim(0,1) + xlim(NA, 4)

p2 <- plot(conditional_effects(list_o_lm$MANUS, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

p3 <- plot(conditional_effects(list_o_lm$Uol, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

p4 <- plot(conditional_effects(list_o_lm$Ppl, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

(p1 + p2) / (p3 + p4) + plot_layout(guides = "collect") & theme_bw()

ggsave( here("Plots","Ord_compare_1.pdf"))
```

```{r}
p1g <- plot(conditional_effects(list_o_gm$OLI, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)+ ylim(0,1) + xlim(NA, 4)

p2g <- plot(conditional_effects(list_o_gm$MANUS, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

p3g <- plot(conditional_effects(list_o_gm$Uol, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

p4g <- plot(conditional_effects(list_o_gm$Ppl, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) + ylim(0,1)

(p1 + p1g) / (p3 + p3g) / (p2 + p2g)  / (p4 + p4g) + plot_layout(guides = "collect") & theme_bw()


ggsave( here("Plots","Ord_compare_2.pdf"), height = 10)
```


```{r}
plot(conditional_effects(list_o_lm$Hl, categorical = TRUE, prob = 0.89), plot=F, points = T)[[1]] +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)+ ylim(0,1)  + theme_bw()
```


#### Plot all effect sizes in one forest plot
Here i'm focusing on the slope of the phenotype


```{r message = FALSE, warning=FALSE}
# Function -> pulls the 7th column, slope, then pivots in long, and scales it to probability
cln <- function(df) as_draws_df(df)[7] %>% gather(var, val) %>% mutate(val = inv_logit_scaled(val))

#run  model
lms <- map(list_o_lm, cln) %>% 
  bind_rows()

#list of slopes in order of means
nms <- lms %>% group_by(var) %>% summarise(mean = mean(val)) %>% arrange(mean) %>%  select(var)

# New df to demonstrate which vars don't overlap 0 at 89%
sigs <- lms %>% group_by(var) %>% median_qi(val - 0.5, .width = c(0.89)) %>% 
  mutate(sigs = case_when(
    .lower > 0 & .upper > 0 ~ "sig",
    .lower < 0 & .upper < 0 ~ "sig",
    #max(var) < 0.5 ~ "sig",
    TRUE ~ "nosig")) %>% select(var, sigs)

```


```{r}
sigs %>% filter(sigs == "sig") %>% select(var) %>% as.list(var)
```

#### Forest Plots
```{r}

lms %>% right_join(sigs, by = 'var') %>% 
  mutate(var = fct_relevel(var, nms$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

ggsave(here("Plots","Ord_sigs.pdf"), height = 15)

lms %>% right_join(sigs, by = 'var') %>% 
  filter(sigs == "sig") %>% 
  mutate(var = fct_relevel(var, nms$var)) %>% 
  ggplot(aes(x = val, y = var, color = sigs)) + 
  stat_pointinterval(.width = c(.66, .89)) +
  geom_vline(xintercept = 0.5, linetype = 3) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  theme_bw()

ggsave(here("Plots","Ord_sigs2.pdf"), height = 10)
```



## Model tuning
I'm not sure how to help the divergent transitions. They seem to appear with the intraspecific variation and the phylogenetic variation. 

```{r message = FALSE, warning=FALSE}
p1 <- get_prior(Loc_Ord2 ~ Uol + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)), data2 = list(A = A),family = cumulative(), data = dat) %>%  mutate(prior = case_when(
  class == "b"  ~ "normal(0, 1)",
  class == "sd" ~ "normal(0, 1)",
  class == "Intercept" ~ "normal(0, 1)",
  TRUE ~ prior ) )

p2 <- get_prior(Loc_Ord2 ~ Uol +  (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)), data2 = list(A = A),family = cumulative(), data = dat) %>%  mutate(prior = case_when(
  class == "b"  ~ "normal(0, 1)",
  class == "sd" ~ "normal(0, 1)",
  class == "Intercept" ~ "normal(0, 1)",
  TRUE ~ prior ) )


m_01 <- brm( Loc_Ord ~ Uol + log_Mass+ (1|Genus_species)+ (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, data2 = list(A = A), prior = p1)

m_01.2 <- brm( Loc_Ord ~ Uol +  (1|Genus_species)+ (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, data2 = list(A = A), prior = p2)

m_01.3 <- brm( Loc_Ord ~ Uol + log_Mass +  (1|Genus_species)+ (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, data2 = list(A = A), prior = p1, control = list(adapt_delta = .99))


m_01.4 <- brm( Loc_Ord ~ Uol + log_Mass +  (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, control = list(adapt_delta = .99),
               data2 = list(A = A),
               prior = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1), class = b),
                prior(normal(0, 1), class = sd)))

m_01.5 <- brm( Loc_Ord ~ Uol + log_Mass , family = cumulative(), data=dat, refresh = 0, cores = 4, prior = c(prior(normal(0, 1), class = Intercept),
                prior(normal(0, 1), class = b)))

```

```{r message = FALSE, warning=FALSE}
ps1 <- get_prior(Loc_Ord2 ~ Uol + log_Mass + (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)), data2 = list(A = A),family = cumulative(), data = dat) %>%  mutate(prior = case_when(
  class == "b"  ~ "normal(0,1)",
  class == "sd" ~ "normal(0, 1)",
  class == "Intercept" ~ "student_t(3,0,2)",
  TRUE ~ prior ) )

ps2 <- get_prior(Loc_Ord2 ~ Uol +  (1 | Genus_species) +  (1|gr(Taxon_Upham_style, cov = A)), data2 = list(A = A),family = cumulative(), data = dat) %>%  mutate(prior = case_when(
  class == "b"  ~ "student(0, 1)",
  class == "sd" ~ "normal(0, 1)",
  class == "student_t(3,0,2)",
  TRUE ~ prior ) )


ms_01 <- brm( Loc_Ord ~ Uol + log_Mass+ (1|Genus_species)+ (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, data2 = list(A = A), prior = ps1)

ms_01.2 <- brm( Loc_Ord ~ Uol +  (1|Genus_species)+ (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, data2 = list(A = A), prior = ps2)

ms_01.3 <- brm( Loc_Ord ~ Uol + log_Mass +  (1|Genus_species)+ (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, data2 = list(A = A), prior = ps1, control = list(adapt_delta = .99))


ms_01.4 <- brm( Loc_Ord ~ Uol + log_Mass +  (1|gr(Taxon_Upham_style,cov = A)), family = cumulative(), data=dat, refresh = 0, cores = 4, control = list(adapt_delta = .99),
               data2 = list(A = A),
               prior = c(prior(student_t(3,0,2), class = Intercept),
                prior(normal(0, 1), class = b),
                prior(normal(0, 1), class = sd)))

ms_01.5 <- brm( Loc_Ord ~ Uol + log_Mass , family = cumulative(), data=dat, refresh = 0, cores = 4, prior = c(prior(student_t(3,0,2), class = Intercept),
                prior(normal(0, 1), class = b)))

```

```{r message = FALSE, warning=FALSE}
#loo(m_01) %>% plot()
loo(m_01.3) %>% plot()
loo(m_01.4) %>% plot()
loo(m_01.5) %>% plot()
```


```{r}
#both
dat %>% slice(loo(m_01) %>% 
  loo::pareto_k_ids(threshold = 0.7)) %>% select(1:4)  -> lo1
#Genus-SPecies
dat %>% slice(loo(m_01.3) %>% 
  loo::pareto_k_ids(threshold = 0.7)) %>% select(1:4) -> lo2
#phylo
dat %>% slice(loo(m_01.4) %>% 
  loo::pareto_k_ids(threshold = 0.7)) %>% select(1:4) -> lo3
```

```{r}
plot(m_01.2, N=3, ask=F)
```


