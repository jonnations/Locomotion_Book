---
title: "Order testing"
output: html_notebook
---

Does model performance improves when other taxonomic levels are accounted for?

The marsupial/placental dichotomy seems pretty major!

There are likely order and family level issues too!

Testing with PES2, MANUS, Ppl, and Ul

AND, how to deal with the other taxonomic options in the mi() imputation?
Maybe it's best to do mi() with phylogeny only, or maybe with Genus_species and phylogeny?


### Load packages and functions  
```{r message = FALSE, warning=FALSE, include = FALSE}

pacman::p_load(tidyverse,  brms, cmdstanr, kableExtra, here, ape, tidybayes, patchwork, glue)

options(brms.backend = "cmdstanr")

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = TRUE)) / sd(x, na.rm)

here::i_am("README.md")
here()

var_complete <- read_rds(here("Data", "var_complete.Rds"))
var_missing <- read_rds(here("Data", "var_missing.Rds"))

source(here("Code","Name_Change.R"))
```

### Load data  
All data loading and wrangling in `Code/Data_Load.Rmd`
```{r}
dat <- read_csv(here("Data", "Extant_Master.csv")) %>% filter( Genus_species !=  'Leopardus_geoffroyi')

#species in dataset
spp_obs <- dat$Taxon_Upham_style %>% unique()

#Color palette
pal = c('#62361B', '#f48a1a', '#e6ab02', '#66a61e', '#31c1bb', '#0d57ff', '#5e1ea6', '#f9581c' , '#f384f8')
```

### Load Tree & Get Cor Matrix

```{r}
tr <- ape::read.nexus(
  here("Data","MCC_Upham_all_mammals.nex"))
tr <- ape::keep.tip(tr, spp_obs)
A <- ape::vcv.phylo(tr, corr = TRUE)
```

## Variables for testing

```{r}
var_test <- c('PES2', 'MANUS', 'Ppl', 'Ul')
var_test2 <- c("PES2", "MANUS")
```


# Fit Order Models
```{r message = FALSE, warning=FALSE, results = 'hide'}

list_b_lm_o  <- vector(mode ="list")

for(i in var_test){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A)) + (1|Order)")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A)) + (1|Order)")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm_o[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm_o %>% write_rds(here("Data","B_lm_ord_test.Rds"))

```

# Fit Subclass Order Models

```{r message = FALSE, warning=FALSE, results = 'hide'}
eutheria <- c("Rodentia", "Carnivora", "Afrosoricida", "Eulipotyphla", "Lagomorpha", "Cingulata", "Paucituberculata", "Primates", "Dermoptera", "Cetartiodactyla", "Hyracoidea", "Erinaceomorpha", "Macroscelidea", "Pilosa", "Scandentia")

metatheria <- c("Diprotodontia", "Dasyuromorphia","Didelphimorphia", "Microbiotheria", "Peramelemorphia",  "Dasyproctidae", "Notoryctemorphia")


dat2 <- dat %>% mutate(Subclass = case_when(Order %in% eutheria ~ "Eutheria",
                                            Order %in% metatheria ~ "Metatheria",
                                            TRUE ~ "Prototheria"))

list_b_lm_os  <- vector(mode ="list")

for(i in var_test){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A)) + (1|Order) + (1|Subclass)")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A)) + (1|Order)")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat2) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm_os[[i]]<- brm(m_form,
                         data=dat2,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm_os %>% write_rds(here("Data","B_lm_ord_sub_test.Rds"))

```



### Family Order

```{r message = FALSE, warning=FALSE, results = 'hide'}

list_b_lm_of  <- vector(mode ="list")

for(i in var_test){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A)) + (1|Order) + (1|Family)")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A)) + (1|Order) + (1|Family)")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm_of[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm_of %>% write_rds(here("Data","B_lm_ord_fam_test.Rds"))

```

### Family Order2
NO FAM or ORDER in mi() imputation
```{r message = FALSE, warning=FALSE, results = 'hide'}

list_b_lm_of2  <- vector(mode ="list")

for(i in var_test2){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|Genus_species)+(1|gr(Taxon_Upham_style,cov = A)) + (1|Order) + (1|Family)")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm_of2[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm_of2 %>% write_rds(here("Data","B_lm_ord_fam_test2.Rds"))

```


### Family No Species

```{r message = FALSE, warning=FALSE, results = 'hide'}

list_b_lm_f  <- vector(mode ="list")

for(i in var_test2){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|gr(Taxon_Upham_style,cov = A))+(1|Family)")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))+(1|Family)")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm_f[[i]]<- brm(m_form,
                         data=dat,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm_f %>% write_rds(here("Data","B_lm_fam_test.Rds"))

```


### NEsted family/order/subclass no Species
From https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#nested-or-crossed
'If the ‘lower-level’ random effect is coded with unique levels, then the two syntaxes (1|a/b) (or (1|a)+(1|a:b)) and (1|a)+(1|b) are equivalent.'
Since there are no overlapping families between orders, nor overlapping orders between subclasses, then I can do individual effects
```{r message = FALSE, warning=FALSE, results = 'hide'}

list_b_lm_nest  <- vector(mode ="list")

for(i in var_test2){
  bin_mod <-  bf(paste0("Loc_bin ~ mi(", i, ")*log_Mass+(1|gr(Taxon_Upham_style,cov = A))+(1|Family)+(1|Order)+(1|Subclass)")) + bernoulli()
  imp_mod <- bf(paste0(i,"| mi() ~ log_Mass + Sl +  
       Hl + Hsw + Hdw + Uol + Ul + Rl + 
       Fl + Fsw + Fdw + Tl + Tmw + 
       (1|gr(Taxon_Upham_style, cov = A))+(1|Family)+(1|Order)+(1|Subclass)")) + gaussian()
  m_form <- bin_mod + imp_mod + set_rescor(FALSE)
  
  pri <- get_prior(m_form,
  data2 = list(A = A),
           data = dat2) %>% 
  mutate(
    prior = case_when(
      class == "b"  ~ "normal(0, 2)",
      class == "sd" ~ "normal(0, 0.5)",
      class == "Intercept" ~ "normal(0, 1)",
      class == "sigma" ~ "normal(0, 0.5)",
      TRUE ~ prior
      ))

  list_b_lm_nest[[i]]<- brm(m_form,
                         data=dat2,
                         refresh = 0,
                         cores = 4,
                         data2 = list(A = A),
                         prior = pri,
                         seed = 145
                         ) 
}

list_b_lm_nest %>% write_rds(here("Data","B_lm_nested_test.Rds"))

```


```{r}
loo(list_b_lm_of2$PES2, list_b_lm_nest$PES2, list_b_lm_f$PES2, list_b_lm_of$PES2, list_b_lm_os$PES2, list_b_lm_o$PES2, mlm$PES2, mgm$PES2, resp = 'Locbin')
```

```{r}
loo(list_b_lm_nest$MANUS, list_b_lm_f$MANUS, list_b_lm_of$MANUS, list_b_lm_os$MANUS, list_b_lm_o$MANUS, mlm$MANUS, mgm$MANUS, resp = 'Locbin')
```

# WHOOPS <- did mi() with Ul!
```{r}
#loo(list_b_lm_of$Ppl, list_b_lm_os$Ppl, list_b_lm_o$Ppl, mlm$Ppl, mgm$Ppl, resp = 'Locbin')
```

```{r}
#loo(list_b_lm_of$Ul, list_b_lm_os$Ul, list_b_lm_o$Ul, mlm$Ul, mgm$Ul, resp = 'Locbin')
```



Preds

From Accuracy script

```{r}
bin_pred_nophy(list_b_lm_of2$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(list_b_lm_nest$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(list_b_lm_f$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(list_b_lm_of$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(list_b_lm_os$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(list_b_lm_o$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(mlm$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_nophy(mgm$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))
```

```{r}
bin_pred_tax(list_b_lm_of2$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(list_b_lm_nest$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(list_b_lm_f$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(list_b_lm_of$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(list_b_lm_os$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(list_b_lm_o$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(mlm$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))

bin_pred_tax(mgm$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))
```



```{r}
bin_pred_nophy <- function(model){
  set.seed(124)
  d <-  predict({{model}}, summary = T, probs = c(0.055, 0.945),  re_formula = NA, resp = 'Locbin')
  d2 <- as.data.frame(d) %>% 
    rename_all(.,
               function(x) case_when(x == 'Estimate.Locbin' | x == 'Estimate' ~ 'pred',
                                     TRUE ~ x)) %>% 
  select(pred) %>% 
  mutate(pred_round = round(pred, digits = 0),
         actual = {{model}}[[2]][[1]],
         #spec = {{model}}[[2]][[]],
        # num = dat[[7]],
         dif = abs(pred_round - actual),
        species = {{model}}[[2]]$Genus_species)
}


bin_pred_tax <- function(model){
  set.seed(124)
  d <-  predict({{model}}, summary = T, probs = c(0.055, 0.945),  re_formula = ~ - (1|gr(Taxon_Upham_style,cov = A)), resp = 'Locbin')
  d2 <- as.data.frame(d) %>% 
    rename_all(.,
               function(x) case_when(x == 'Estimate.Locbin' | x == 'Estimate' ~ 'pred',
                                     TRUE ~ x)) %>% 
  select(pred) %>% 
  mutate(pred_round = round(pred, digits = 0),
         actual = {{model}}[[2]][[1]],
         #spec = {{model}}[[2]][[]],
        # num = dat[[7]],
         dif = abs(pred_round - actual),
        species = {{model}}[[2]]$Genus_species)
}

```


check tax
BIG DEAL!
```{r}
bin_pred_tax2 <- function(model){
  set.seed(124)
  d <-  predict({{model}}, summary = T, probs = c(0.055, 0.945),  re_formula = ~ (1|Order) + (1|Family) + (1|Genus_species), resp = 'Locbin')
  d2 <- as.data.frame(d) %>% 
    rename_all(.,
               function(x) case_when(x == 'Estimate.Locbin' | x == 'Estimate' ~ 'pred',
                                     TRUE ~ x)) %>% 
  select(pred) %>% 
  mutate(pred_round = round(pred, digits = 0),
         actual = {{model}}[[2]][[1]],
         #spec = {{model}}[[2]][[]],
        # num = dat[[7]],
         dif = abs(pred_round - actual),
        species = {{model}}[[2]]$Genus_species)
}



bin_pred_tax2(list_b2t$PES2) %>% summarise(accuracy = round((sum(dif == 0)/427) * 100, digits = 1))
```

